<!doctype html> <html lang=ja > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/Joe.jl/libs/katex/katex.min.css"> <link rel=stylesheet  href="/Joe.jl/libs/highlight/github.min.css"> <link rel=stylesheet  href="css/magnific-popup.css" /> <link href="/Joe.jl/css/franklin.css" rel=stylesheet > <link href="/Joe.jl/css/vela.css" rel=stylesheet > <script src="/Joe.jl/libs/vela/jquery.min.js"></script> <link rel=icon  href="/Joe.jl/assets/favicon.ico"> <title>機械学習の数理100問をjuliaでやる </title> <div class=main-nav  id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>機械学習の数理100問</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/Joe.jl/index.html">トップ</a> <li><a href="" class=has-arrow >統計的機械学習の数理100問</a> <ul> <li><a href="/Joe.jl/StatisticalML/chap1/">第一章　線形回帰</a> <li><a href="/Joe.jl/StatisticalML/chap2/">第二章　分類</a> <li><a href="/Joe.jl/StatisticalML/chap3/">第三章　リサンプリング</a> <li><a href="/Joe.jl/StatisticalML/chap4/">第四章　情報量基準</a> <li><a href="/Joe.jl/StatisticalML/chap5/">第五章　正則化</a> <li><a href="/Joe.jl/StatisticalML/chap6/">第六章　非線形回帰</a> <li><a href="/Joe.jl/StatisticalML/chap7/">第七章　決定木</a> </ul> <li><a href="" class=has-arrow >スパース推定100問</a> <ul> <li> </ul> </ul> </nav> </div> <main id=panel > <div class="toggle-button hamburger hamburger--spin"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">非線形回帰</h1> <hr> <div class=franklin-content ><p><div class=franklin-toc ><ol><li><a href="#多項式回帰">多項式回帰</a><ol><li><a href="#例52">例52</a><li><a href="#例53">例53</a></ol><li><a href="#スプライン回帰">スプライン回帰</a><ol><li><a href="#例54">例54</a><li><a href="#例56_自然なスプライン曲線">例56 自然なスプライン曲線</a></ol><li><a href="#平滑化スプライン">平滑化スプライン</a><ol><li><a href="#例57">例57</a><li><a href="#例58_クロスバリデーションによる平滑化スプラインの正則化乗数の最適化">例58 クロスバリデーションによる平滑化スプラインの正則化乗数の最適化</a></ol><li><a href="#局所回帰">局所回帰</a><ol><li><a href="#例60_nadaraya-watson推定量">例60 nadaraya-watson推定量</a><li><a href="#例61_局所線形回帰">例61 局所線形回帰</a></ol><li><a href="#一般化加法モデル">一般化加法モデル</a><ol><li><a href="#例62">例62</a><li><a href="#例63">例63</a></ol></ol></div> <h2 id="多項式回帰"><a href="#多項式回帰" class=header-anchor >多項式回帰</a></h2> <h3 id="例52"><a href="#例52" class=header-anchor >例52</a></h3> <p>sin関数に乱数を足した観測データを多項式で回帰します。 <div class=blank ></div> データの生成</p> <pre><code class=language-julia >using Plots, Joe, Random
Random.seed&#33;&#40;12&#41;
n &#61; 100; x &#61; randn&#40;n&#41;; y &#61; sin.&#40;x&#41; &#43; randn&#40;n&#41;;
p52 &#61; scatter&#40;x,y,xlabel&#61;&quot;x&quot;, ylabel&#61;&quot;y&quot;, label&#61;false, legend&#61;:topleft&#41;;</code></pre> <p>3、5、7次の多項式で回帰します。 多項式回帰用にデータセットを作る関数を定義したので、これを使ってみます。</p> <pre><code class=language-julia >polynomial&#40;x::Vector, P::Int&#41; &#61; hcat&#40;&#91;x.^p for p in 1:P&#93;...&#41;
polynomial&#40;x::AbstractRange, P::Int&#41;&#61; polynomial&#40;collect&#40;x&#41;,P&#41;</code></pre> <pre><code class=language-julia >using Joe:polynomial
p_set &#61; &#91;3,5,7&#93;
x_seq &#61; -3:0.1:3
for p in p_set
    X &#61; polynomial&#40;x,p&#41;
    β̂ &#61; multiple_regression&#40;X,y&#41;
    ŷ &#61; insert_ones&#40;polynomial&#40;x_seq,p&#41;&#41;*β̂
    plot&#33;&#40;p52, x_seq,ŷ,label&#61;&quot;p &#61; &#36;p&quot;&#41;
end</code></pre> <img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-1.svg" alt=""> <h3 id="例53"><a href="#例53" class=header-anchor >例53</a></h3> <p>矩形波に雑音をノイズをのせたデータを作って、フィッティングします。 まずはデータを生成します。</p> <pre><code class=language-julia >using Plots, Random
Random.seed&#33;&#40;123&#41;
n &#61; 100; x &#61; randn&#40;n&#41; * π
y &#61; abs.&#40;round.&#40;x&#41; .&#37;2&#41; * 2  .- 1&#43; randn&#40;n&#41;*0.2
p53 &#61; scatter&#40;x,y,label&#61; false&#41;;</code></pre> <p>基底関数が、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f_1(x) = 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_2(x) = \cos(x) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >cos</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>3</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>2</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_3(x) = \cos(2x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >cos</span><span class=mopen >(</span><span class=mord >2</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>4</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>3</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_4(x) = \cos(3x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >cos</span><span class=mopen >(</span><span class=mord >3</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>の場合と、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f_1(x) = 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_2(x) = \sin(x) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>3</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>2</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_3(x) = \sin(2x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class=mord >2</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>4</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>4</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_4(x) = \sin(4x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class=mord >4</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>の場合とでそれぞれ回帰分析します。 準備として先ほどのpolynomial関数をべき乗以外にも対応できるように多重ディスパッチで拡張します。</p> <pre><code class=language-julia >polynomial&#40;x::Vector, P::Int, f::Function&#41; &#61; hcat&#40;&#91;f.&#40;p*x&#41; for p in 1:P&#93;...&#41;
polynomial&#40;x::AbstractRange, P::Int, f::Function&#41; &#61; polynomial&#40;collect&#40;x&#41;, P, f&#41;</code></pre> <p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><mo>−</mo><mn>8</mn><mo separator=true >,</mo><mn>8</mn><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(-8,8)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >−</span><span class=mord >8</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >8</span><span class=mclose >)</span></span></span></span>の区間でフィッティングします。</p> <pre><code class=language-julia >x_seq &#61; -8:0.2:8</code></pre><pre><code class="plaintext code-output">-8.0:0.2:8.0</code></pre>
<p>cosの場合</p>
<pre><code class=language-julia >X_cos &#61; polynomial&#40;x,3,cos&#41;
β̂_cos &#61; multiple_regression&#40;X_cos,y&#41;
ŷ_cos &#61; insert_ones&#40;polynomial&#40;x_seq,3,cos&#41;&#41;*β̂_cos;</code></pre>
<p>sinの場合</p>
<pre><code class=language-julia >X_sin &#61; polynomial&#40;x,3,sin&#41;
β̂_sin &#61; multiple_regression&#40;X_sin,y&#41;
ŷ_sin &#61; insert_ones&#40;polynomial&#40;x_seq,3,sin&#41;&#41;*β̂_sin;</code></pre>
<p>可視化します。</p>
<pre><code class=language-julia >plot&#33;&#40;p53,x_seq,ŷ_cos,label&#61;&quot;cos&quot;&#41;
plot&#33;&#40;p53,x_seq,ŷ_sin,label&#61;&quot;sin&quot;&#41;</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-2.svg" alt=""> <div class=blank ></div> cosを基底にとったほうが、上手くフィッティングできることが確認できました。</p>
<h2 id="スプライン回帰"><a href="#スプライン回帰" class=header-anchor >スプライン回帰</a></h2>
<p>スプライン回帰については、まずスプラインに関する複合型を作って、 function-like objectを実装しました。 spline_matrix関数は、あとで変更できるようにキーワード引数にしました。</p>
<pre><code class=language-julia >using Parameters
@with_kw mutable struct Spline&#123;T&lt;:Number&#125;
    xmin::T &#61; -1.0
    xmax::T &#61; 1.0
    K::Int &#61; 5
end
function spline_matrix&#40;x::Vector,K::Int,xmin,xmax&#41;
    n &#61; length&#40;x&#41;
    Knots &#61; range&#40;xmin,stop&#61;xmax,length&#61;K&#41;
    X &#61; zeros&#40;n,K&#43;4&#41;
    X&#91;:,1&#93; .&#61; 1
    X&#91;:,2&#93; .&#61; x
    X&#91;:,3&#93; .&#61; x.^2
    X&#91;:,4&#93; .&#61; x.^3
    for j in 1:K
        X&#91;:,j&#43;4&#93; &#61; @. max&#40;x - Knots&#91;j&#93;, 0&#41;^3
    end
    return X
end
function &#40;s::Spline&#41;&#40;x::Vector, y::Vector, x_pred::Vector;
          spline_matrix::Function&#61;spline_matrix&#41;
    @unpack xmin, xmax, K &#61; s
    Knots &#61; range&#40;xmin,stop&#61;xmax,length&#61;K&#41;
    X &#61; spline_matrix&#40;x,K,xmin,xmax&#41;
    X_pred &#61; spline_matrix&#40;x_pred,K,xmin,xmax&#41;
    β &#61; &#40;X&#39;X&#41;\X&#39;y
    ypred &#61; X_pred*β
end
&#40;s::Spline&#41;&#40;x::Vector, y::Vector, x_pred::AbstractRange;kwargs...&#41; &#61; s&#40;x,y,collect&#40;x_pred&#41;;kwargs...&#41;</code></pre>
<h3 id="例54"><a href="#例54" class=header-anchor >例54</a></h3>
<p>sinカーブに乱数を加えたデータにスプライン回帰でフィッティングします。 分割点数が7以上でデータに追随していることがわかります。</p>
<pre><code class=language-julia >using Plots, Random
using Joe: Spline
using Joe
Random.seed&#33;&#40;123&#41;
n &#61; 100; x &#61; randn&#40;n&#41;*2π; y &#61; sin.&#40;x&#41; &#43; 0.2randn&#40;n&#41;
p54 &#61; scatter&#40;x,y,xlims&#61;&#40;-5,5&#41;,xlabel&#61;&quot;x&quot;,ylabel&#61;&quot;f&#40;x&#41;&quot;,label&#61;false&#41;
K_set &#61; 5:2:9
for K in K_set
    spline &#61; Spline&#40;xmin&#61;-2π, xmax&#61;2π, K&#61;K&#41;
    u_seq &#61; -5:0.2:5
    v_seq &#61; spline&#40;x,y,u_seq&#41;
    plot&#33;&#40;p54, u_seq,v_seq, label&#61;&quot;K &#61; &#36;K&quot;&#41;
end</code></pre>
<img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-5.svg" alt="">
<h3 id="例56_自然なスプライン曲線"><a href="#例56_自然なスプライン曲線" class=header-anchor >例56 自然なスプライン曲線</a></h3>
<p>スプライン曲線の両端が直線になっているものです。 原著では、関数dとか関数hを定義して使っていました。 そんなことはしたくないけど、いい名前もないので、関数内で定義して使うことにしました。</p>
<pre><code class=language-julia >function natural_spline_matrix&#40;x::Vector, K::Int, xmin, xmax&#41;
    n &#61; length&#40;x&#41;
    Knots &#61; range&#40;xmin,stop&#61;xmax,length&#61;K&#41;
    X &#61; zeros&#40;n,K&#41;
    X&#91;:,1&#93; .&#61; 1
    X&#91;:,2&#93; .&#61; x
    d&#40;x::Vector,a::Number,b::Number&#41; &#61;  @. &#40;max&#40;x-a,0&#41;^3 - max&#40;x-b,0&#41;^3&#41; / &#40;b-a&#41;
    for j in 1:K-2
        X&#91;:,j&#43;2&#93; &#61; d&#40;x,Knots&#91;j&#93;,Knots&#91;end&#93;&#41; - d&#40;x,Knots&#91;end-1&#93;,Knots&#91;end&#93;&#41;
    end
    return X
end</code></pre>
<p>例54と同じデータに、ただのスプラインと自然なスプラインの回帰を適用し、 結果を可視化します。まずデータの生成とスプライン型を定義します。</p>
<pre><code class=language-julia >using Plots, Random
using Joe: Spline
using Joe
Random.seed&#33;&#40;123&#41;
n &#61; 100; x &#61; randn&#40;n&#41;*2π; y &#61; sin.&#40;x&#41; &#43; 0.2randn&#40;n&#41;
spline6 &#61; Spline&#40;xmin&#61;-5, xmax&#61;5, K&#61;6&#41;;
spline11 &#61; Spline&#40;xmin&#61;-5, xmax&#61;5, K&#61;11&#41;;</code></pre>
<p>次に回帰を行います。自然なスプラインで回帰を行う場合には、キーワード引数を指定します。</p>
<pre><code class=language-julia >u_seq &#61; -6:0.02:6;
v_seq6 &#61; spline6&#40;x,y,u_seq&#41;;
v_seq11 &#61; spline11&#40;x,y,u_seq&#41;;
w_seq6 &#61; spline6&#40;x,y,u_seq;splinematrix&#61;Joe.natural_spline_matrix&#41;;
w_seq11 &#61; spline11&#40;x,y,u_seq;splinematrix&#61;Joe.natural_spline_matrix&#41;;</code></pre>
<p>可視化します。</p>
<pre><code class=language-julia >p56_1 &#61; scatter&#40;x,y,xlims&#61;&#40;-7,7&#41;,xlabel&#61;&quot;x&quot;,ylabel&#61;&quot;f&#40;x&#41;,g&#40;x&#41;&quot;,label&#61;false,title&#61;&quot;K&#61;6&quot;&#41;
p56_2 &#61; scatter&#40;x,y,xlims&#61;&#40;-7,7&#41;,xlabel&#61;&quot;x&quot;,ylabel&#61;&quot;f&#40;x&#41;,g&#40;x&#41;&quot;,label&#61;false,title&#61;&quot;K&#61;11&quot;&#41;
plot&#33;&#40;p56_1,u_seq,v_seq6,label&#61;&quot;spline&quot;&#41;
plot&#33;&#40;p56_1,u_seq,w_seq6,label&#61;&quot;natural spline&quot;&#41;
vline&#33;&#40;p56_1,&#91;-5,5&#93;;linewidth&#61;1,label&#61;false&#41;
vline&#33;&#40;p56_1,range&#40;-5,stop&#61;5,length&#61;6&#41;;linestyle&#61;:dash,label&#61;false&#41;
plot&#33;&#40;p56_2,u_seq,v_seq11,label&#61;&quot;spline&quot;&#41;
plot&#33;&#40;p56_2,u_seq,w_seq11,label&#61;&quot;natural spline&quot;&#41;
vline&#33;&#40;p56_2,&#91;-5,5&#93;;linewidth&#61;1,label&#61;false&#41;
vline&#33;&#40;p56_2,range&#40;-5,stop&#61;5,length&#61;11&#41;;linestyle&#61;:dash,label&#61;false&#41;
p56 &#61; plot&#40;p56_1,p56_2,layout&#61;&#40;2,1&#41;&#41;</code></pre>
<img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-7.svg" alt="">
<h2 id="平滑化スプライン"><a href="#平滑化スプライン" class=header-anchor >平滑化スプライン</a></h2>
<p>平滑化スプラインは区切り点を指定するときにデータ点自身を使っていたので、 以下のように書き直しました。&#40;function-like objectにするまでもなかった。&#41;</p>
<pre><code class=language-julia >struct SmoothingSpline
    x::Vector
end
function &#40;s::SmoothingSpline&#41;&#40;y::Vector,x_pred::Union&#123;Vector,AbstractRange&#125;;λ&#61;0&#41;
    x &#61; s.x
    X &#61; smoothing_spline_matrix&#40;x,x&#41;
    G &#61; green_silverman&#40;x&#41;
    γ &#61; &#40;X&#39;X &#43; λ*G&#41;\X&#39;y
    X_pred &#61; smoothing_spline_matrix&#40;x_pred,x&#41;
    ypred &#61; X_pred*γ
end</code></pre>
<p>ただし、smoothing<em>spline</em>matrixとgreen_silverman関数は以下の通りです。</p>
<pre><code class=language-julia >function smoothing_spline_matrix&#40;x::Vector,Knots::Union&#123;Vector, AbstractRange&#125;&#41;
    n &#61; length&#40;x&#41;
    K &#61; length&#40;Vector&#41;
    X &#61; zeros&#40;n,K&#41;
    X&#91;:,1&#93; .&#61; 1
    X&#91;:,2&#93; .&#61; x
    d&#40;x::Vector,a::Number,b::Number&#41; &#61;  @. &#40;max&#40;x-a,0&#41;^3 - max&#40;x-b,0&#41;^3&#41; / &#40;b-a&#41;
    for j in 1:K-2
        X&#91;:,j&#43;2&#93; &#61; d&#40;x,Knots&#91;j&#93;,Knots&#91;end&#93;&#41; - d&#40;x,Knots&#91;end-1&#93;,Knots&#91;end&#93;&#41;
    end
    return X
end

function green_silverman&#40;x::Vector&#41;
    n &#61; length&#40;x&#41;
    g &#61; zeros&#40;n,n&#41;
    for i in 3:n ,j in i:n
        g&#91;j,i&#93; &#61;&#40;12&#40;x&#91;end&#93;-x&#91;end-1&#93;&#41;*&#40;x&#91;end-1&#93;-x&#91;j-2&#93;&#41;*&#40;x&#91;end-1&#93;-x&#91;i-2&#93;&#41;&#43;
                &#40;x&#91;end-1&#93;-x&#91;j-2&#93;&#41;^2*&#40;12x&#91;end-1&#93;&#43;6x&#91;j-2&#93;-18x&#91;i-2&#93;&#41;&#41;/
                &#40;x&#91;end&#93;-x&#91;i-2&#93;&#41;/&#40;x&#91;end&#93;-x&#91;j-2&#93;&#41;
        g&#91;i,j&#93; &#61; g&#91;j,i&#93;
    end
    return g
end</code></pre>
<h3 id="例57"><a href="#例57" class=header-anchor >例57</a></h3>
<p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><mo stretchy=false >(</mo><mo>−</mo><mn>5</mn><mo separator=true >,</mo><mn>5</mn><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">x\in(-5,5)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >−</span><span class=mord >5</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >5</span><span class=mclose >)</span></span></span></span>の一様分布からサンプルを生成します。 原著では、サンプル生成コードが間違っているようなので、ipynbの記述を参照しました。</p>
<pre><code class=language-julia >using Plots, Random, Distributions
using Joe: SmoothingSpline
using Joe
Random.seed&#33;&#40;11&#41;
n &#61; 100;
x &#61; rand&#40;Uniform&#40;-5,5&#41;,n&#41;; y &#61; x .&#43; 2sin.&#40;x&#41; &#43; randn&#40;n&#41;
index &#61; sortperm&#40;x&#41;; x &#61; x&#91;index&#93;; y &#61; y&#91;index&#93;

p57 &#61; scatter&#40;x,y,label&#61;false&#41;

sspline &#61; SmoothingSpline&#40;x&#41;
u_seq &#61; -8:0.02:8
λ_set &#61; &#91;40,400,1000&#93;
for λ in λ_set
    v_seq &#61; sspline&#40;y,u_seq,λ&#61;λ&#41;
    plot&#33;&#40;p57,u_seq,v_seq,label&#61;&quot;λ &#61; &#36;λ&quot;&#41;
end
p57
plot&#33;&#40;p57,u_seq,sspline&#40;y,u_seq,λ&#61;1&#41;,label&#61;&quot;λ &#61; 1&quot;&#41;</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-8.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span>が大きくなると、直線に近くなっていくようです。</p>
<h3 id="例58_クロスバリデーションによる平滑化スプラインの正則化乗数の最適化"><a href="#例58_クロスバリデーションによる平滑化スプラインの正則化乗数の最適化" class=header-anchor >例58 クロスバリデーションによる平滑化スプラインの正則化乗数の最適化</a></h3>
<p>3章で使った線形回帰の場合の高速なクロスバリデーションの公式</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>C</mi><mi>V</mi><mo stretchy=false >[</mo><mi>λ</mi><mo stretchy=false >]</mo><mo><mi mathvariant=normal >≔</mi></mo><munder><mo>∑</mo><mi>S</mi></munder><mi mathvariant=normal >∣</mi><mi mathvariant=normal >∣</mi><mo stretchy=false >(</mo><mi>I</mi><mo>−</mo><msub><mi>H</mi><mi>S</mi></msub><mo stretchy=false >[</mo><mi>λ</mi><mo stretchy=false >]</mo><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>e</mi><mi>S</mi></msub><mi mathvariant=normal >∣</mi><msup><mi mathvariant=normal >∣</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">CV[\lambda] \coloneqq \sum_{S}||(I - H_S[\lambda])^{-1}e_S ||^2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=mopen >[</span><span class="mord mathnormal">λ</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel ><span class=mrel ><span class=mop  style="position:relative;top:-0.03472em;">:</span></span><span class=mrel ><span class=mspace  style="margin-right:-0.06666666666666667em;"></span></span><span class=mrel >=</span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.344341em;vertical-align:-1.294336em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.0500050000000003em;"><span style="top:-1.855664em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span style="top:-3.050005em;"><span class=pstrut  style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.294336em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >∣</span><span class=mord >∣</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >[</span><span class="mord mathnormal">λ</span><span class=mclose >]</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >∣</span><span class=mord ><span class=mord >∣</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>H</mi><mi>S</mi></msub><mo stretchy=false >[</mo><mi>λ</mi><mo stretchy=false >]</mo><mo><mi mathvariant=normal >≔</mi></mo><msub><mi>X</mi><mi>s</mi></msub><mo stretchy=false >(</mo><msup><mi>X</mi><mi mathvariant=sans-serif >T</mi></msup><mi>X</mi><mo>+</mo><mi>λ</mi><mi>G</mi><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>S</mi><mi mathvariant=sans-serif >T</mi></msubsup></mrow><annotation encoding="application/x-tex">H_S[\lambda] \coloneqq X_s(X^\mathsf{T}X+\lambda G)^{-1}X^\mathsf{T}_S</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >[</span><span class="mord mathnormal">λ</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel ><span class=mrel ><span class=mop  style="position:relative;top:-0.03472em;">:</span></span><span class=mrel ><span class=mspace  style="margin-right:-0.06666666666666667em;"></span></span><span class=mrel >=</span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.149108em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1491079999999998em;vertical-align:-0.25em;"></span><span class="mord mathnormal">λ</span><span class="mord mathnormal">G</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8991079999999998em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></span>
<p>を利用して、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span>の最適化を行います。 以下のcv<em>ss</em>fast関数を定義して利用します。</p>
<pre><code class=language-julia >function cv_ss_fast&#40;X::AbstractArray,y::Vector,G::AbstractArray,K::Int;λ&#61;0&#41;
    n &#61; length&#40;y&#41;; m &#61; round&#40;Int,n/K&#41;
    H &#61; X*&#40;&#40;X&#39;X &#43; λ*G&#41;\X&#39;&#41;
    e &#61; &#40;I&#40;n&#41; - H&#41;*y
    S &#61; 0
    @views for j in 1:K
        test &#61; j*m-m&#43;1:j*m;
        err &#61; &#40;I&#40;m&#41;-H&#91;test,test&#93;&#41; \ e&#91;test&#93;
        S &#43;&#61; dot&#40;err,err&#41;
    end
    return S/n,tr&#40;H&#41;
end</code></pre>
<p>3章の使ったcv_fast関数とほぼ同様ですが、定数項の列を付けないことと、 正則化乗数が引数になっていること、クロスバリデーション誤差だけでなく、 Hのトレースも返していることなどが異なります。 まずはデータを生成します。</p>
<pre><code class=language-julia >using Random, Distributions
Random.seed&#33;&#40;11&#41;
n &#61; 100; x &#61; rand&#40;Uniform&#40;-5,5&#41;,n&#41; ; y &#61; x -0.02sin.&#40;x&#41;-0.1randn&#40;n&#41;;
index &#61; sortperm&#40;x&#41;; x &#61; x&#91;index&#93;; y &#61; y&#91;index&#93;;</code></pre>
<p>XとGを計算します。</p>
<pre><code class=language-julia >X &#61; Joe.smoothing_spline_matrix&#40;x,x&#41;;
G &#61; Joe.green_silverman&#40;x&#41;;</code></pre>
<p>クロスバリデーション誤差とHのトレース&#40;有効自由度&#41;を求めます。</p>
<pre><code class=language-julia >result &#61; hcat&#40;&#91;collect&#40;Joe.cv_ss_fast&#40;X,y,G,n,λ&#61;λ&#41;&#41; for λ in 1:50&#93;...&#41;
using Plots
p58 &#61; plot&#40;result&#91;2,:&#93;, result&#91;1,:&#93;,label&#61; false,
            xlabel&#61;&quot;有効自由度&quot;, ylabel&#61;&quot;CVによる予測誤差&quot;,
            title &#61; &quot;有効自由度とCVによる予測誤差&quot;&#41;
savefig&#40;p58,joinpath&#40;@OUTPUT,&quot;fig6-9.svg&quot;&#41;&#41;</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-9.svg" alt=""> <div class=blank ></div> &#40;注&#41;ちなみに生成するデータによって、グラフの形はかなり変わります。</p>
<h2 id="局所回帰"><a href="#局所回帰" class=header-anchor >局所回帰</a></h2>
<h3 id="例60_nadaraya-watson推定量"><a href="#例60_nadaraya-watson推定量" class=header-anchor >例60 nadaraya-watson推定量</a></h3>
<p>nadaraya-watson推定量の計算の実装です。 カーネルは関数の引数にして、別のものに変更できるようにしました。&#40;ここでは他のカーネルは出てきませんが。&#41;</p>
<pre><code class=language-julia >epanechnikov&#40;x,y,λ&#41; &#61; norm&#40;x-y&#41;/λ |&gt; c -&gt; max&#40;0.75*&#40;1-c^2&#41;,0&#41;

function nadaraya_watson_estimator&#40;x_observed::Vector,y_observed::Vector,kk::Function,x_pred::TP;λ&#61;1.0&#41; where &#123;TP&lt;:Number&#125;
    n &#61; length&#40;y_observed&#41;
    S &#61; 0; T &#61; 0;
    for i in 1:n
        S &#43;&#61; kk&#40;x_observed&#91;i&#93;,x_pred,λ&#41;*y_observed&#91;i&#93;
        T &#43;&#61; kk&#40;x_observed&#91;i&#93;,x_pred,λ&#41;
    end
    result &#61; T &#61;&#61; 0 ? 0 : S/T
    return result
end
ベクトル化にも対応しています。
function nadaraya_watson_estimator&#40;x_observed::Vector,y_observed::Vector,kk::Function,x_pred::Union&#123;Vector,AbstractRange&#125;;λ&#61;1.0&#41;
    y_pred &#61; &#91;nadaraya_watson_estimator&#40;x_observed,y_observed,kk,xp; λ&#41; for xp in x_pred&#93;
end</code></pre>
<p><div class=note ><div class=title >😲 Note</div>
<div class=content >epanechnikoc関数に絶対値の処理は必要になりますが、abs関数を使うよりもLinearAlgebra.jlのnormを使った方が、多次元化に対応できて良いと思います。</div></div> トイデータとしてsin関数にノイズをのせたデータを作成します。</p>
<pre><code class=language-julia >using Random
Random.seed&#33;&#40;123&#41;
n&#61;250;x &#61; 2randn&#40;n&#41;; y &#61; sin.&#40;2π*x&#41; &#43; randn&#40;n&#41;/4

using Plots
p58 &#61; scatter&#40;x,y,xlims&#61;&#40;-3,3&#41;,label&#61;false&#41;
xx &#61; -3:0.1:3
using Joe:nadaraya_watson_estimator, epanechnikov
using LinearAlgebra</code></pre>
<p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>0.05</mn><mo separator=true >,</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\lambda=0.05,0.25</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class=mord >0</span><span class=mord >.</span><span class=mord >0</span><span class=mord >5</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >0</span><span class=mord >.</span><span class=mord >2</span><span class=mord >5</span></span></span></span>の場合にプロットしてみます。</p>
<pre><code class=language-julia >plot&#33;&#40;p58,xx,nadaraya_watson_estimator&#40;x,y,epanechnikov,xx;λ&#61;0.05&#41;,
         label&#61;&quot;λ &#61; 0.05&quot;&#41;;
plot&#33;&#40;p58,xx,nadaraya_watson_estimator&#40;x,y,epanechnikov,xx;λ&#61;0.25&#41;,
         label&#61;&quot;λ &#61; 0.25&quot;&#41;;</code></pre>
<p>クロスバリデーションで<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span>を最適化してプロットしてみます。</p>
<pre><code class=language-julia >λ_seq &#61; 0.05:0.01:1
SS_min &#61; Inf
λ_best &#61; λ_seq&#91;1&#93;
for λ in λ_seq
    SS &#61; 0
    m &#61; Int&#40;n/10&#41;
    for k in 1:10
        test &#61; k*m-m&#43;1:k*m
        train &#61; setdiff&#40;1:n,test&#41;
        y_pred &#61; nadaraya_watson_estimator&#40;x&#91;train&#93;,y&#91;train&#93;,epanechnikov,x&#91;test&#93;;λ&#61;λ&#41;
        SS &#43;&#61; dot&#40;y&#91;test&#93;-y_pred,y&#91;test&#93;-y_pred&#41;
    end
    if SS &lt; SS_min
        SS_min &#61; SS
        λ_best &#61; λ
    end
end

plot&#33;&#40;p58,xx,nadaraya_watson_estimator&#40;x,y,epanechnikov,xx;λ&#61;λ_best&#41;, label&#61;&quot;λ &#61; λ_best&quot;&#41;</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-10.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mrow><mi>b</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\lambda_{best}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">λ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>はこの程度の値になるようです。</p>
<pre><code class=language-julia >@show λ_best;</code></pre><pre><code class="plaintext code-output">λ_best = 0.19
</code></pre>
<h3 id="例61_局所線形回帰"><a href="#例61_局所線形回帰" class=header-anchor >例61 局所線形回帰</a></h3>
<p>カーネル関数<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>を成分に持った対角行列<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold-italic >W</mi></mrow><annotation encoding="application/x-tex">\bm{W}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68611em;vertical-align:0em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span></span></span></span>を</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=bold-italic >W</mi><mo>=</mo><mrow><mo fence=true >[</mo><mtable rowspacing=0.15999999999999992em  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mi>k</mi><mo stretchy=false >(</mo><mi>x</mi><mo separator=true >,</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mo lspace=0em  rspace=0em >⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mi><mi mathvariant=normal >⋮</mi><mpadded height="+0em" voffset=0em ><mspace mathbackground=black  width=0em  height=1.5em ></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mo lspace=0em  rspace=0em >⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mi><mi mathvariant=normal >⋮</mi><mpadded height="+0em" voffset=0em ><mspace mathbackground=black  width=0em  height=1.5em ></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mo lspace=0em  rspace=0em >⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mi>k</mi><mo stretchy=false >(</mo><mi>x</mi><mo separator=true >,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence=true >]</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{W} = \begin{bmatrix}
 k(x,x_1) &amp; \cdots &amp; 0 \\
 \vdots &amp; \ddots &amp; \vdots \\
 0 &amp; \cdots &amp; k(x,x_n) \end{bmatrix} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68611em;vertical-align:0em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:4.260000000000001em;vertical-align:-1.8800000000000006em;"></span><span class=minner ><span class=mopen ><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.352005em;"><span style="top:-1.9499950000000004em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-3.0999950000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.1109850000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.352005em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.850025em;"><span></span></span></span></span></span></span><span class=mord ><span class=mtable ><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.3800000000000003em;"><span style="top:-5.2275em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-3.3674999999999997em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord ><span class=mord >⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1674999999999995em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord >0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.8800000000000006em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.3800000000000003em;"><span style="top:-5.04em;"><span class=pstrut  style="height:3.5em;"></span><span class=mord ><span class=minner >⋯</span></span></span><span style="top:-3.1799999999999997em;"><span class=pstrut  style="height:3.5em;"></span><span class=mord ><span class=minner >⋱</span></span></span><span style="top:-1.9799999999999995em;"><span class=pstrut  style="height:3.5em;"></span><span class=mord ><span class=minner >⋯</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.8800000000000006em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.3800000000000003em;"><span style="top:-5.2275em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-3.3674999999999997em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord ><span class=mord >⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1674999999999995em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.8800000000000006em;"><span></span></span></span></span></span></span></span><span class=mclose ><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.352005em;"><span style="top:-1.9499950000000004em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-3.0999950000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.1109850000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.352005em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.850025em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>とした時、</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>L</mi><mo><mi mathvariant=normal >≔</mi></mo><mo stretchy=false >(</mo><mi mathvariant=bold-italic >y</mi><mo>−</mo><mi><mrow><mi mathvariant=bold-italic >X</mi><mi mathvariant=bold-italic >β</mi></mrow></mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><msup><mo stretchy=false >)</mo><mi mathvariant=sans-serif >T</mi></msup><mi mathvariant=bold-italic >W</mi><mo stretchy=false >(</mo><mi mathvariant=bold-italic >y</mi><mo>−</mo><mi><mrow><mi mathvariant=bold-italic >X</mi><mi mathvariant=bold-italic >β</mi></mrow></mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex"> L \coloneqq (\bm{y} - \bm{Xβ}(x))^\mathsf{T}\bm{W}(\bm{y} - \bm{Xβ}(x)) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel ><span class=mrel ><span class=mop  style="position:relative;top:-0.03472em;">:</span></span><span class=mrel ><span class=mspace  style="margin-right:-0.06666666666666667em;"></span></span><span class=mrel >=</span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.149108em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mclose >)</span></span></span></span></span>
<p>を最小化する<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold-italic >β</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">\bm{\beta}(x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>を求めます。</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mfrac><mrow><mi mathvariant=normal >∂</mi><mi>L</mi></mrow><mrow><mi mathvariant=normal >∂</mi><mi mathvariant=bold-italic >β</mi></mrow></mfrac><mo>=</mo><mo>−</mo><mn>2</mn><msup><mi mathvariant=bold-italic >X</mi><mi mathvariant=sans-serif >T</mi></msup><mi mathvariant=bold-italic >W</mi><mo stretchy=false >(</mo><mi mathvariant=bold-italic >y</mi><mo>−</mo><mi><mrow><mi mathvariant=bold-italic >X</mi><mi mathvariant=bold-italic >β</mi></mrow></mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex"> \dfrac{\partial L}{\partial \bm{\beta}} =
-2\bm{X}^\mathsf{T}\bm{W}(\bm{y} - \bm{Xβ}(x))=0</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:2.25188em;vertical-align:-0.8804400000000001em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">L</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.1751179999999999em;vertical-align:-0.25em;"></span><span class=mord >−</span><span class=mord >2</span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9251179999999999em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >0</span></span></span></span></span>
<p>とおくと、</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=bold-italic >β</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mo stretchy=false >(</mo><msup><mi mathvariant=bold-italic >X</mi><mi mathvariant=sans-serif >T</mi></msup><mi><mrow><mi mathvariant=bold-italic >W</mi><mi mathvariant=bold-italic >X</mi></mrow></mi><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msup><mi mathvariant=bold-italic >X</mi><mi mathvariant=sans-serif >T</mi></msup><mi><mrow><mi mathvariant=bold-italic >W</mi><mi mathvariant=bold-italic >y</mi></mrow></mi></mrow><annotation encoding="application/x-tex"> \bm{\beta}(x) = (\bm{X}^\mathsf{T}\bm{WX})^{-1}\bm{X}^\mathsf{T}\bm{Wy}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.1751179999999999em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9251179999999999em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9251179999999999em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span></span></span></span></span>
<p>で係数を求めることができます。この処理を関数で実装するわけですが、原著のlocalという関数名は良くないので、 local_regressionという名前で実装しました。例では1次元に限定していましたが、 多次元データにも対応させています。</p>
<pre><code class=language-julia >function local_regression&#40;x::Matrix&#123;T&#125;,
                          y::Vector&#123;T&#125;,
                          kernel::Function;
                          x_pred&#61;x, λ&#61;1&#41; where &#123;T&lt;:Number&#125;
    N,_ &#61; size&#40;x&#41;
    @assert N&#61;&#61;length&#40;y&#41;
    X &#61; insert_ones&#40;x&#41;
    m,_ &#61; size&#40;x_pred&#41;
    y_pred &#61; Vector&#123;T&#125;&#40;undef,m&#41;
    for j in 1:m
        W &#61; &#91;kernel&#40;x&#91;i,:&#93;,x_pred&#91;j,:&#93;,λ&#41; for i in 1:N&#93; |&gt; diagm
        β̂ &#61; &#40;X&#39;*W*X&#41;\X&#39;*W*y
        y_pred&#91;j&#93; &#61; dot&#40;insert_ones&#40;x_pred&#91;j,:&#93;&#41;,β̂&#41;
    end
    return y_pred
end
function local_regression&#40;x::Vector&#123;T&#125;, y::Vector&#123;T&#125;,kernel::Function;x_pred&#61;x,λ&#61;1&#41; where &#123;T&lt;:Number&#125;
    return local_regression&#40;x&#91;:,:&#93;,y,kernel;x_pred&#61;x_pred&#91;:,:&#93;,λ&#61;λ&#41;
end</code></pre>
<p>トイデータとしてsin関数にノイズをのせたデータを作成します。</p>
<pre><code class=language-julia >using Random,Joe
Random.seed&#33;&#40;123&#41;
n&#61;30; x &#61; 2π*rand&#40;n&#41; .- π; y &#61; sin.&#40;x&#41; .&#43; randn&#40;&#41;
p61 &#61; scatter&#40;x,y,label&#61;false&#41;
m &#61; 200;U &#61; -π:π/m:π;</code></pre>
<p>正則化パラメータ<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\lambda=1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>の条件で回帰分析を行ってプロットします。</p>
<pre><code class=language-julia >V &#61; Joe.local_regression&#40;x,y,Joe.epanechnikov;x_pred&#61;U&#41;
plot&#33;&#40;p61,U,V,label&#61;false,title &#61; &quot;局所線形回帰&#40;p&#61;1, N&#61;30&#41;&quot;&#41;</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-11.svg" alt=""> <div class=blank ></div> 予測したい場所の数だけ回帰分析の計算を行わないといけないので、元データの数が多い時は 計算が大変そうです。</p>
<h2 id="一般化加法モデル"><a href="#一般化加法モデル" class=header-anchor >一般化加法モデル</a></h2>
<h3 id="例62"><a href="#例62" class=header-anchor >例62</a></h3>
<p>基底関数の数が有限個なら線形回帰の手法で係数を求められるけど、 数が多すぎると逆行列を解くのが大変でどうしましょうとい３う話。 バックフィッティングは例63で実装します。</p>
<h3 id="例63"><a href="#例63" class=header-anchor >例63</a></h3>
<p>以下のようなpolyfit関数を実装しました。</p>
<pre><code class=language-julia >function polyfit&#40;x,y;x_pred&#61;x, P::Int&#61;3&#41;
    X &#61; polynomial&#40;x,P&#41;
    X_pred&#61;polynomial&#40;x_pred,P&#41;
    β̂ &#61; multiple_regression&#40;X,y&#41;
    y_pred &#61; insert_ones&#40;X_pred&#41; * β̂
end</code></pre>
<p><a href="#例61">例６１</a>のデータに一般加法モデルを適用します。 先に多項式でフィッティングして残りを局所線形回帰で求めていきます。</p>
<pre><code class=language-julia >using Random,Joe
Random.seed&#33;&#40;123&#41;
n&#61;30; x &#61; 2π*rand&#40;n&#41; .- π; sort&#33;&#40;x&#41;; y &#61; sin.&#40;x&#41; .&#43; randn&#40;&#41;
y₁ &#61; zeros&#40;n&#41;; y₂ &#61; zeros&#40;n&#41;
for k in 1:10
    y₁ &#61; Joe.polyfit&#40;x,y-y₂&#41;
    y₂ &#61; Joe.local_regression&#40;x,y-y₁,Joe.epanechnikov&#41;
end
using Plots
p62_1 &#61; plot&#40;x,y₁,label&#61;false,xlabel&#61;&quot;x&quot;,ylabel&#61;&quot;f&#40;x&#41;&quot;,title&#61;&quot;多項式回帰&#40;3次&#41;&quot;&#41;
p62_2 &#61; plot&#40;x,y₂,label&#61;false,xlabel&#61;&quot;x&quot;,ylabel&#61;&quot;f&#40;x&#41;&quot;,title&#61;&quot;局所線形回帰&quot;&#41;
p62　&#61; plot&#40;p62_1,p62_2,layout&#61;&#40;1,2&#41;&#41;</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-12.svg" alt=""> <div class=blank ></div> 大体３次多項式で回帰されていて、残りが局所線形回帰されていることが分かります。 先に3次多項式で回帰したためでしょうか。 確認してみることにします。</p>
<pre><code class=language-julia >using Random,Joe
Random.seed&#33;&#40;123&#41;
n&#61;30; x &#61; 2π*rand&#40;n&#41; .- π; sort&#33;&#40;x&#41;; y &#61; sin.&#40;x&#41; .&#43; randn&#40;&#41;
y₁ &#61; zeros&#40;n&#41;; y₂ &#61; zeros&#40;n&#41;
using Plots
for k in 1:10
    y₂ &#61; Joe.local_regression&#40;x,y-y₁,Joe.epanechnikov&#41;
    y₁ &#61; Joe.polyfit&#40;x,y-y₂&#41;
end
p62_3 &#61; plot&#40;x,y₁,label&#61;false,xlabel&#61;&quot;x&quot;,ylabel&#61;&quot;f&#40;x&#41;&quot;,title&#61;&quot;多項式回帰&#40;3次&#41;&quot;&#41;
p62_4 &#61; plot&#40;x,y₂,label&#61;false,xlabel&#61;&quot;x&quot;,ylabel&#61;&quot;f&#40;x&#41;&quot;,title&#61;&quot;局所線形回帰&quot;&#41;
p62_5　&#61; plot&#40;p62_3,p62_4,layout&#61;&#40;1,2&#41;&#41;</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-12-2.svg" alt=""> <div class=blank ></div> 多項式回帰の影響が減って、局所線形回帰の成分が大きくなることが確認できました。</p>
  <p style="text-align:right">  めでたしめでたし </p>  <button onclick="topFunction()" id=myBtn  title="Go to top">Top</button> </p>
<div class=page-foot >
  <div class=copyright >
    &copy; Kei Hanafusa. Last modified: August 09, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
  </main> 
  <script src="/Joe.jl/libs/vela/metisMenu.min.js"></script>
  <script src="/Joe.jl/libs/vela/slideout.min.js"></script>
  <script src="/Joe.jl/libs/myBtn/myBtn.js"></script>
  <script src="/Joe.jl/libs/popup/jquery.magnific-popup.min.js"></script>
  <script src="/Joe.jl/libs/popup/mypopup.js"></script>
  
    



  
  
    <script src="/Joe.jl/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>