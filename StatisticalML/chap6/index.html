<!doctype html> <html lang=ja > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/Joe.jl/libs/katex/katex.min.css"> <link rel=stylesheet  href="/Joe.jl/libs/highlight/github.min.css"> <link rel=stylesheet  href="css/magnific-popup.css" /> <link href="/Joe.jl/css/franklin.css" rel=stylesheet > <link href="/Joe.jl/css/vela.css" rel=stylesheet > <script src="/Joe.jl/libs/vela/jquery.min.js"></script> <link rel=icon  href="/Joe.jl/assets/favicon.ico"> <title>機械学習の数理100問をjuliaでやる </title> <div class=main-nav  id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>機械学習の数理100問</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/Joe.jl/index.html">トップ</a> <li><a href="" class=has-arrow >統計的機械学習の数理100問</a> <ul> <li><a href="/Joe.jl/StatisticalML/chap1/">第一章　線形回帰</a> <li><a href="/Joe.jl/StatisticalML/chap2/">第二章　分類</a> <li><a href="/Joe.jl/StatisticalML/chap3/">第三章　リサンプリング</a> <li><a href="/Joe.jl/StatisticalML/chap4/">第四章　情報量基準</a> <li><a href="/Joe.jl/StatisticalML/chap5/">第五章　正則化</a> <li><a href="/Joe.jl/StatisticalML/chap6/">第六章　非線形回帰</a> </ul> <li><a href="" class=has-arrow >スパース推定100問</a> <ul> <li> </ul> </ul> </nav> </div> <main id=panel > <div class="toggle-button hamburger hamburger--spin"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">非線形回帰</h1> <hr> <div class=franklin-content ><p><div class=franklin-toc ><ol><li><a href="#多項式回帰">多項式回帰</a><ol><li><a href="#例52">例52</a><li><a href="#例53">例53</a></ol><li><a href="#スプライン回帰">スプライン回帰</a><ol><li><a href="#例54">例54</a><li><a href="#例56_自然なスプライン曲線">例56 自然なスプライン曲線</a></ol><li><a href="#平滑化スプライン">平滑化スプライン</a><ol><li><a href="#例57">例57</a><li><a href="#例58_クロスバリデーションによる平滑化スプラインの正則化乗数の最適化">例58 クロスバリデーションによる平滑化スプラインの正則化乗数の最適化</a></ol><li><a href="#局所回帰">局所回帰</a><ol><li><a href="#例60_nadaraya-watson推定量">例60 nadaraya-watson推定量</a><li><a href="#例61_局所線形回帰">例61 局所線形回帰</a></ol><li><a href="#一般化加法モデル">一般化加法モデル</a><ol><li><a href="#例62">例62</a><li><a href="#例63">例63</a></ol></ol></div> <h2 id="多項式回帰"><a href="#多項式回帰">多項式回帰</a></h2> <h3 id="例52"><a href="#例52">例52</a></h3> <p>sin関数に乱数を足した観測データを多項式で回帰します。 <div class=blank ></div> データの生成</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Plots, Joe, Random
Random.seed!(<span class=hljs-number >12</span>)
n = <span class=hljs-number >100</span>; x = randn(n); y = sin.(x) + randn(n);
p52 = scatter(x,y,xlabel=<span class=hljs-string >&quot;x&quot;</span>, ylabel=<span class=hljs-string >&quot;y&quot;</span>, label=<span class=hljs-literal >false</span>, legend=:topleft);</code></pre> <p>3、5、7次の多項式で回帰します。 多項式回帰用にデータセットを作る関数を定義したので、これを使ってみます。</p> <pre><code class="julia hljs">polynomial(x::<span class=hljs-built_in >Vector</span>, P::<span class=hljs-built_in >Int</span>) = hcat([x.^p <span class=hljs-keyword >for</span> p <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:P]...)
polynomial(x::<span class=hljs-built_in >AbstractRange</span>, P::<span class=hljs-built_in >Int</span>)= polynomial(collect(x),P)</code></pre> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Joe:polynomial
p_set = [<span class=hljs-number >3</span>,<span class=hljs-number >5</span>,<span class=hljs-number >7</span>]
x_seq = -<span class=hljs-number >3</span>:<span class=hljs-number >0.1</span>:<span class=hljs-number >3</span>
<span class=hljs-keyword >for</span> p <span class=hljs-keyword >in</span> p_set
    X = polynomial(x,p)
    β̂ = multiple_regression(X,y)
    ŷ = insert_ones(polynomial(x_seq,p))*β̂
    plot!(p52, x_seq,ŷ,label=<span class=hljs-string >&quot;p = <span class=hljs-variable >$p</span>&quot;</span>)
<span class=hljs-keyword >end</span></code></pre> <img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-1.svg" alt=""> <h3 id="例53"><a href="#例53">例53</a></h3> <p>矩形波に雑音をノイズをのせたデータを作って、フィッティングします。 まずはデータを生成します。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Plots, Random
Random.seed!(<span class=hljs-number >123</span>)
n = <span class=hljs-number >100</span>; x = randn(n) * <span class=hljs-literal >π</span>
y = abs.(round.(x) .%<span class=hljs-number >2</span>) * <span class=hljs-number >2</span>  .- <span class=hljs-number >1</span>+ randn(n)*<span class=hljs-number >0.2</span>
p53 = scatter(x,y,label= <span class=hljs-literal >false</span>);</code></pre> <p>基底関数が、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f_1(x) = 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_2(x) = \cos(x) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >cos</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>3</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>2</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_3(x) = \cos(2x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >cos</span><span class=mopen >(</span><span class=mord >2</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>4</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>3</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_4(x) = \cos(3x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >cos</span><span class=mopen >(</span><span class=mord >3</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>の場合と、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f_1(x) = 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_2(x) = \sin(x) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>3</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>2</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_3(x) = \sin(2x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class=mord >2</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>4</mn></msub><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>4</mn><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f_4(x) = \sin(4x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class=mord >4</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>の場合とでそれぞれ回帰分析します。 準備として先ほどのpolynomial関数をべき乗以外にも対応できるように多重ディスパッチで拡張します。</p> <pre><code class="julia hljs">polynomial(x::<span class=hljs-built_in >Vector</span>, P::<span class=hljs-built_in >Int</span>, f::<span class=hljs-built_in >Function</span>) = hcat([f.(p*x) <span class=hljs-keyword >for</span> p <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:P]...)
polynomial(x::<span class=hljs-built_in >AbstractRange</span>, P::<span class=hljs-built_in >Int</span>, f::<span class=hljs-built_in >Function</span>) = polynomial(collect(x), P, f)</code></pre> <p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy=false >(</mo><mo>−</mo><mn>8</mn><mo separator=true >,</mo><mn>8</mn><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">(-8,8)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >−</span><span class=mord >8</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >8</span><span class=mclose >)</span></span></span></span>の区間でフィッティングします。</p> <pre><code class="julia hljs">x_seq = -<span class=hljs-number >8</span>:<span class=hljs-number >0.2</span>:<span class=hljs-number >8</span></code></pre><pre><code class="plaintext hljs">-8.0:0.2:8.0</code></pre>
<p>cosの場合</p>
<pre><code class="julia hljs">X_cos = polynomial(x,<span class=hljs-number >3</span>,cos)
β̂_cos = multiple_regression(X_cos,y)
ŷ_cos = insert_ones(polynomial(x_seq,<span class=hljs-number >3</span>,cos))*β̂_cos;</code></pre>
<p>sinの場合</p>
<pre><code class="julia hljs">X_sin = polynomial(x,<span class=hljs-number >3</span>,sin)
β̂_sin = multiple_regression(X_sin,y)
ŷ_sin = insert_ones(polynomial(x_seq,<span class=hljs-number >3</span>,sin))*β̂_sin;</code></pre>
<p>可視化します。</p>
<pre><code class="julia hljs">plot!(p53,x_seq,ŷ_cos,label=<span class=hljs-string >&quot;cos&quot;</span>)
plot!(p53,x_seq,ŷ_sin,label=<span class=hljs-string >&quot;sin&quot;</span>)</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-2.svg" alt=""> <div class=blank ></div> cosを基底にとったほうが、上手くフィッティングできることが確認できました。</p>
<h2 id="スプライン回帰"><a href="#スプライン回帰">スプライン回帰</a></h2>
<p>スプライン回帰については、まずスプラインに関する複合型を作って、 function-like objectを実装しました。 spline_matrix関数は、あとで変更できるようにキーワード引数にしました。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Parameters
<span class=hljs-meta >@with_kw</span> <span class=hljs-keyword >mutable struct</span> Spline{T&lt;:<span class=hljs-built_in >Number</span>}
    xmin::T = -<span class=hljs-number >1.0</span>
    xmax::T = <span class=hljs-number >1.0</span>
    K::<span class=hljs-built_in >Int</span> = <span class=hljs-number >5</span>
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >function</span> spline_matrix(x::<span class=hljs-built_in >Vector</span>,K::<span class=hljs-built_in >Int</span>,xmin,xmax)
    n = length(x)
    Knots = range(xmin,stop=xmax,length=K)
    X = zeros(n,K+<span class=hljs-number >4</span>)
    X[:,<span class=hljs-number >1</span>] .= <span class=hljs-number >1</span>
    X[:,<span class=hljs-number >2</span>] .= x
    X[:,<span class=hljs-number >3</span>] .= x.^<span class=hljs-number >2</span>
    X[:,<span class=hljs-number >4</span>] .= x.^<span class=hljs-number >3</span>
    <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:K
        X[:,j+<span class=hljs-number >4</span>] = @. max(x - Knots[j], <span class=hljs-number >0</span>)^<span class=hljs-number >3</span>
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> X
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >function</span> (s::Spline)(x::<span class=hljs-built_in >Vector</span>, y::<span class=hljs-built_in >Vector</span>, x_pred::<span class=hljs-built_in >Vector</span>;
          spline_matrix::<span class=hljs-built_in >Function</span>=spline_matrix)
    <span class=hljs-meta >@unpack</span> xmin, xmax, K = s
    Knots = range(xmin,stop=xmax,length=K)
    X = spline_matrix(x,K,xmin,xmax)
    X_pred = spline_matrix(x_pred,K,xmin,xmax)
    β = (X&#x27;X)\X&#x27;y
    ypred = X_pred*β
<span class=hljs-keyword >end</span>
(s::Spline)(x::<span class=hljs-built_in >Vector</span>, y::<span class=hljs-built_in >Vector</span>, x_pred::<span class=hljs-built_in >AbstractRange</span>;kwargs...) = s(x,y,collect(x_pred);kwargs...)</code></pre>
<h3 id="例54"><a href="#例54">例54</a></h3>
<p>sinカーブに乱数を加えたデータにスプライン回帰でフィッティングします。 分割点数が7以上でデータに追随していることがわかります。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Plots, Random
<span class=hljs-keyword >using</span> Joe: Spline
<span class=hljs-keyword >using</span> Joe
Random.seed!(<span class=hljs-number >123</span>)
n = <span class=hljs-number >100</span>; x = randn(n)*<span class=hljs-number >2</span><span class=hljs-literal >π</span>; y = sin.(x) + <span class=hljs-number >0.2</span>randn(n)
p54 = scatter(x,y,xlims=(-<span class=hljs-number >5</span>,<span class=hljs-number >5</span>),xlabel=<span class=hljs-string >&quot;x&quot;</span>,ylabel=<span class=hljs-string >&quot;f(x)&quot;</span>,label=<span class=hljs-literal >false</span>)
K_set = <span class=hljs-number >5</span>:<span class=hljs-number >2</span>:<span class=hljs-number >9</span>
<span class=hljs-keyword >for</span> K <span class=hljs-keyword >in</span> K_set
    spline = Spline(xmin=-<span class=hljs-number >2</span><span class=hljs-literal >π</span>, xmax=<span class=hljs-number >2</span><span class=hljs-literal >π</span>, K=K)
    u_seq = -<span class=hljs-number >5</span>:<span class=hljs-number >0.2</span>:<span class=hljs-number >5</span>
    v_seq = spline(x,y,u_seq)
    plot!(p54, u_seq,v_seq, label=<span class=hljs-string >&quot;K = <span class=hljs-variable >$K</span>&quot;</span>)
<span class=hljs-keyword >end</span></code></pre>
<img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-5.svg" alt="">
<h3 id="例56_自然なスプライン曲線"><a href="#例56_自然なスプライン曲線">例56 自然なスプライン曲線</a></h3>
<p>スプライン曲線の両端が直線になっているものです。 原著では、関数dとか関数hを定義して使っていました。 そんなことはしたくないけど、いい名前もないので、関数内で定義して使うことにしました。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> natural_spline_matrix(x::<span class=hljs-built_in >Vector</span>, K::<span class=hljs-built_in >Int</span>, xmin, xmax)
    n = length(x)
    Knots = range(xmin,stop=xmax,length=K)
    X = zeros(n,K)
    X[:,<span class=hljs-number >1</span>] .= <span class=hljs-number >1</span>
    X[:,<span class=hljs-number >2</span>] .= x
    d(x::<span class=hljs-built_in >Vector</span>,a::<span class=hljs-built_in >Number</span>,b::<span class=hljs-built_in >Number</span>) =  @. (max(x-a,<span class=hljs-number >0</span>)^<span class=hljs-number >3</span> - max(x-b,<span class=hljs-number >0</span>)^<span class=hljs-number >3</span>) / (b-a)
    <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:K-<span class=hljs-number >2</span>
        X[:,j+<span class=hljs-number >2</span>] = d(x,Knots[j],Knots[<span class=hljs-keyword >end</span>]) - d(x,Knots[<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>],Knots[<span class=hljs-keyword >end</span>])
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> X
<span class=hljs-keyword >end</span></code></pre>
<p>例54と同じデータに、ただのスプラインと自然なスプラインの回帰を適用し、 結果を可視化します。まずデータの生成とスプライン型を定義します。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Plots, Random
<span class=hljs-keyword >using</span> Joe: Spline
<span class=hljs-keyword >using</span> Joe
Random.seed!(<span class=hljs-number >123</span>)
n = <span class=hljs-number >100</span>; x = randn(n)*<span class=hljs-number >2</span><span class=hljs-literal >π</span>; y = sin.(x) + <span class=hljs-number >0.2</span>randn(n)
spline6 = Spline(xmin=-<span class=hljs-number >5</span>, xmax=<span class=hljs-number >5</span>, K=<span class=hljs-number >6</span>);
spline11 = Spline(xmin=-<span class=hljs-number >5</span>, xmax=<span class=hljs-number >5</span>, K=<span class=hljs-number >11</span>);</code></pre>
<p>次に回帰を行います。自然なスプラインで回帰を行う場合には、キーワード引数を指定します。</p>
<pre><code class="julia hljs">u_seq = -<span class=hljs-number >6</span>:<span class=hljs-number >0.02</span>:<span class=hljs-number >6</span>;
v_seq6 = spline6(x,y,u_seq);
v_seq11 = spline11(x,y,u_seq);
w_seq6 = spline6(x,y,u_seq;splinematrix=Joe.natural_spline_matrix);
w_seq11 = spline11(x,y,u_seq;splinematrix=Joe.natural_spline_matrix);</code></pre>
<p>可視化します。</p>
<pre><code class="julia hljs">p56_1 = scatter(x,y,xlims=(-<span class=hljs-number >7</span>,<span class=hljs-number >7</span>),xlabel=<span class=hljs-string >&quot;x&quot;</span>,ylabel=<span class=hljs-string >&quot;f(x),g(x)&quot;</span>,label=<span class=hljs-literal >false</span>,title=<span class=hljs-string >&quot;K=6&quot;</span>)
p56_2 = scatter(x,y,xlims=(-<span class=hljs-number >7</span>,<span class=hljs-number >7</span>),xlabel=<span class=hljs-string >&quot;x&quot;</span>,ylabel=<span class=hljs-string >&quot;f(x),g(x)&quot;</span>,label=<span class=hljs-literal >false</span>,title=<span class=hljs-string >&quot;K=11&quot;</span>)
plot!(p56_1,u_seq,v_seq6,label=<span class=hljs-string >&quot;spline&quot;</span>)
plot!(p56_1,u_seq,w_seq6,label=<span class=hljs-string >&quot;natural spline&quot;</span>)
vline!(p56_1,[-<span class=hljs-number >5</span>,<span class=hljs-number >5</span>];linewidth=<span class=hljs-number >1</span>,label=<span class=hljs-literal >false</span>)
vline!(p56_1,range(-<span class=hljs-number >5</span>,stop=<span class=hljs-number >5</span>,length=<span class=hljs-number >6</span>);linestyle=:dash,label=<span class=hljs-literal >false</span>)
plot!(p56_2,u_seq,v_seq11,label=<span class=hljs-string >&quot;spline&quot;</span>)
plot!(p56_2,u_seq,w_seq11,label=<span class=hljs-string >&quot;natural spline&quot;</span>)
vline!(p56_2,[-<span class=hljs-number >5</span>,<span class=hljs-number >5</span>];linewidth=<span class=hljs-number >1</span>,label=<span class=hljs-literal >false</span>)
vline!(p56_2,range(-<span class=hljs-number >5</span>,stop=<span class=hljs-number >5</span>,length=<span class=hljs-number >11</span>);linestyle=:dash,label=<span class=hljs-literal >false</span>)
p56 = plot(p56_1,p56_2,layout=(<span class=hljs-number >2</span>,<span class=hljs-number >1</span>))</code></pre>
<img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-7.svg" alt="">
<h2 id="平滑化スプライン"><a href="#平滑化スプライン">平滑化スプライン</a></h2>
<p>平滑化スプラインは区切り点を指定するときにデータ点自身を使っていたので、 以下のように書き直しました。&#40;function-like objectにするまでもなかった。&#41;</p>
<pre><code class="julia hljs"><span class=hljs-keyword >struct</span> SmoothingSpline
    x::<span class=hljs-built_in >Vector</span>
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >function</span> (s::SmoothingSpline)(y::<span class=hljs-built_in >Vector</span>,x_pred::<span class=hljs-built_in >Union</span>{<span class=hljs-built_in >Vector</span>,<span class=hljs-built_in >AbstractRange</span>};λ=<span class=hljs-number >0</span>)
    x = s.x
    X = smoothing_spline_matrix(x,x)
    G = green_silverman(x)
    γ = (X&#x27;X + λ*G)\X&#x27;y
    X_pred = smoothing_spline_matrix(x_pred,x)
    ypred = X_pred*γ
<span class=hljs-keyword >end</span></code></pre>
<p>ただし、smoothing<em>spline</em>matrixとgreen_silverman関数は以下の通りです。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> smoothing_spline_matrix(x::<span class=hljs-built_in >Vector</span>,Knots::<span class=hljs-built_in >Union</span>{<span class=hljs-built_in >Vector</span>, <span class=hljs-built_in >AbstractRange</span>})
    n = length(x)
    K = length(<span class=hljs-built_in >Vector</span>)
    X = zeros(n,K)
    X[:,<span class=hljs-number >1</span>] .= <span class=hljs-number >1</span>
    X[:,<span class=hljs-number >2</span>] .= x
    d(x::<span class=hljs-built_in >Vector</span>,a::<span class=hljs-built_in >Number</span>,b::<span class=hljs-built_in >Number</span>) =  @. (max(x-a,<span class=hljs-number >0</span>)^<span class=hljs-number >3</span> - max(x-b,<span class=hljs-number >0</span>)^<span class=hljs-number >3</span>) / (b-a)
    <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:K-<span class=hljs-number >2</span>
        X[:,j+<span class=hljs-number >2</span>] = d(x,Knots[j],Knots[<span class=hljs-keyword >end</span>]) - d(x,Knots[<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>],Knots[<span class=hljs-keyword >end</span>])
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> X
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> green_silverman(x::<span class=hljs-built_in >Vector</span>)
    n = length(x)
    g = zeros(n,n)
    <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >3</span>:n ,j <span class=hljs-keyword >in</span> i:n
        g[j,i] =(<span class=hljs-number >12</span>(x[<span class=hljs-keyword >end</span>]-x[<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>])*(x[<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>]-x[j-<span class=hljs-number >2</span>])*(x[<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>]-x[i-<span class=hljs-number >2</span>])+
                (x[<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>]-x[j-<span class=hljs-number >2</span>])^<span class=hljs-number >2</span>*(<span class=hljs-number >12</span>x[<span class=hljs-keyword >end</span>-<span class=hljs-number >1</span>]+<span class=hljs-number >6</span>x[j-<span class=hljs-number >2</span>]-<span class=hljs-number >18</span>x[i-<span class=hljs-number >2</span>]))/
                (x[<span class=hljs-keyword >end</span>]-x[i-<span class=hljs-number >2</span>])/(x[<span class=hljs-keyword >end</span>]-x[j-<span class=hljs-number >2</span>])
        g[i,j] = g[j,i]
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> g
<span class=hljs-keyword >end</span></code></pre>
<h3 id="例57"><a href="#例57">例57</a></h3>
<p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><mo stretchy=false >(</mo><mo>−</mo><mn>5</mn><mo separator=true >,</mo><mn>5</mn><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">x\in(-5,5)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >∈</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord >−</span><span class=mord >5</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >5</span><span class=mclose >)</span></span></span></span>の一様分布からサンプルを生成します。 原著では、サンプル生成コードが間違っているようなので、ipynbの記述を参照しました。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Plots, Random, Distributions
<span class=hljs-keyword >using</span> Joe: SmoothingSpline
<span class=hljs-keyword >using</span> Joe
Random.seed!(<span class=hljs-number >11</span>)
n = <span class=hljs-number >100</span>;
x = rand(Uniform(-<span class=hljs-number >5</span>,<span class=hljs-number >5</span>),n); y = x .+ <span class=hljs-number >2</span>sin.(x) + randn(n)
index = sortperm(x); x = x[index]; y = y[index]

p57 = scatter(x,y,label=<span class=hljs-literal >false</span>)

sspline = SmoothingSpline(x)
u_seq = -<span class=hljs-number >8</span>:<span class=hljs-number >0.02</span>:<span class=hljs-number >8</span>
λ_set = [<span class=hljs-number >40</span>,<span class=hljs-number >400</span>,<span class=hljs-number >1000</span>]
<span class=hljs-keyword >for</span> λ <span class=hljs-keyword >in</span> λ_set
    v_seq = sspline(y,u_seq,λ=λ)
    plot!(p57,u_seq,v_seq,label=<span class=hljs-string >&quot;λ = <span class=hljs-variable >$λ</span>&quot;</span>)
<span class=hljs-keyword >end</span>
p57
plot!(p57,u_seq,sspline(y,u_seq,λ=<span class=hljs-number >1</span>),label=<span class=hljs-string >&quot;λ = 1&quot;</span>)</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-8.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span>が大きくなると、直線に近くなっていくようです。</p>
<h3 id="例58_クロスバリデーションによる平滑化スプラインの正則化乗数の最適化"><a href="#例58_クロスバリデーションによる平滑化スプラインの正則化乗数の最適化">例58 クロスバリデーションによる平滑化スプラインの正則化乗数の最適化</a></h3>
<p>3章で使った線形回帰の場合の高速なクロスバリデーションの公式</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>C</mi><mi>V</mi><mo stretchy=false >[</mo><mi>λ</mi><mo stretchy=false >]</mo><mo><mi mathvariant=normal >≔</mi></mo><munder><mo>∑</mo><mi>S</mi></munder><mi mathvariant=normal >∣</mi><mi mathvariant=normal >∣</mi><mo stretchy=false >(</mo><mi>I</mi><mo>−</mo><msub><mi>H</mi><mi>S</mi></msub><mo stretchy=false >[</mo><mi>λ</mi><mo stretchy=false >]</mo><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>e</mi><mi>S</mi></msub><mi mathvariant=normal >∣</mi><msup><mi mathvariant=normal >∣</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">CV[\lambda] \coloneqq \sum_{S}||(I - H_S[\lambda])^{-1}e_S ||^2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class=mopen >[</span><span class="mord mathnormal">λ</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel ><span class=mrel ><span class=mop  style="position:relative;top:-0.03472em;">:</span></span><span class=mrel ><span class=mspace  style="margin-right:-0.06666666666666667em;"></span></span><span class=mrel >=</span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.344341em;vertical-align:-1.294336em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.0500050000000003em;"><span style="top:-1.855664em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span style="top:-3.050005em;"><span class=pstrut  style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.294336em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >∣</span><span class=mord >∣</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >[</span><span class="mord mathnormal">λ</span><span class=mclose >]</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >∣</span><span class=mord ><span class=mord >∣</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><msub><mi>H</mi><mi>S</mi></msub><mo stretchy=false >[</mo><mi>λ</mi><mo stretchy=false >]</mo><mo><mi mathvariant=normal >≔</mi></mo><msub><mi>X</mi><mi>s</mi></msub><mo stretchy=false >(</mo><msup><mi>X</mi><mi mathvariant=sans-serif >T</mi></msup><mi>X</mi><mo>+</mo><mi>λ</mi><mi>G</mi><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>S</mi><mi mathvariant=sans-serif >T</mi></msubsup></mrow><annotation encoding="application/x-tex">H_S[\lambda] \coloneqq X_s(X^\mathsf{T}X+\lambda G)^{-1}X^\mathsf{T}_S</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >[</span><span class="mord mathnormal">λ</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel ><span class=mrel ><span class=mop  style="position:relative;top:-0.03472em;">:</span></span><span class=mrel ><span class=mspace  style="margin-right:-0.06666666666666667em;"></span></span><span class=mrel >=</span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.149108em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1491079999999998em;vertical-align:-0.25em;"></span><span class="mord mathnormal">λ</span><span class="mord mathnormal">G</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8991079999999998em;"><span style="top:-2.4530000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></span>
<p>を利用して、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span>の最適化を行います。 以下のcv<em>ss</em>fast関数を定義して利用します。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> cv_ss_fast(X::<span class=hljs-built_in >AbstractArray</span>,y::<span class=hljs-built_in >Vector</span>,G::<span class=hljs-built_in >AbstractArray</span>,K::<span class=hljs-built_in >Int</span>;λ=<span class=hljs-number >0</span>)
    n = length(y); m = round(<span class=hljs-built_in >Int</span>,n/K)
    H = X*((X&#x27;X + λ*G)\X&#x27;)
    e = (I(n) - H)*y
    S = <span class=hljs-number >0</span>
    <span class=hljs-meta >@views</span> <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:K
        test = j*m-m+<span class=hljs-number >1</span>:j*m;
        err = (I(m)-H[test,test]) \ e[test]
        S += dot(err,err)
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> S/n,tr(H)
<span class=hljs-keyword >end</span></code></pre>
<p>3章の使ったcv_fast関数とほぼ同様ですが、定数項の列を付けないことと、 正則化乗数が引数になっていること、クロスバリデーション誤差だけでなく、 Hのトレースも返していることなどが異なります。 まずはデータを生成します。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Random, Distributions
Random.seed!(<span class=hljs-number >11</span>)
n = <span class=hljs-number >100</span>; x = rand(Uniform(-<span class=hljs-number >5</span>,<span class=hljs-number >5</span>),n) ; y = x -<span class=hljs-number >0.02</span>sin.(x)-<span class=hljs-number >0.1</span>randn(n);
index = sortperm(x); x = x[index]; y = y[index];</code></pre>
<p>XとGを計算します。</p>
<pre><code class="julia hljs">X = Joe.smoothing_spline_matrix(x,x);
G = Joe.green_silverman(x);</code></pre>
<p>クロスバリデーション誤差とHのトレース&#40;有効自由度&#41;を求めます。</p>
<pre><code class="julia hljs">result = hcat([collect(Joe.cv_ss_fast(X,y,G,n,λ=λ)) <span class=hljs-keyword >for</span> λ <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >50</span>]...)
<span class=hljs-keyword >using</span> Plots
p58 = plot(result[<span class=hljs-number >2</span>,:], result[<span class=hljs-number >1</span>,:],label= <span class=hljs-literal >false</span>,
            xlabel=<span class=hljs-string >&quot;有効自由度&quot;</span>, ylabel=<span class=hljs-string >&quot;CVによる予測誤差&quot;</span>,
            title = <span class=hljs-string >&quot;有効自由度とCVによる予測誤差&quot;</span>)
savefig(p58,joinpath(<span class=hljs-meta >@OUTPUT</span>,<span class=hljs-string >&quot;fig6-9.svg&quot;</span>))</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-9.svg" alt=""> <div class=blank ></div> &#40;注&#41;ちなみに生成するデータによって、グラフの形はかなり変わります。</p>
<h2 id="局所回帰"><a href="#局所回帰">局所回帰</a></h2>
<h3 id="例60_nadaraya-watson推定量"><a href="#例60_nadaraya-watson推定量">例60 nadaraya-watson推定量</a></h3>
<p>nadaraya-watson推定量の計算の実装です。 カーネルは関数の引数にして、別のものに変更できるようにしました。&#40;ここでは他のカーネルは出てきませんが。&#41;</p>
<pre><code class="julia hljs">epanechnikov(x,y,λ) = norm(x-y)/λ |&gt; c -&gt; max(<span class=hljs-number >0.75</span>*(<span class=hljs-number >1</span>-c^<span class=hljs-number >2</span>),<span class=hljs-number >0</span>)

<span class=hljs-keyword >function</span> nadaraya_watson_estimator(x_observed::<span class=hljs-built_in >Vector</span>,y_observed::<span class=hljs-built_in >Vector</span>,kk::<span class=hljs-built_in >Function</span>,x_pred::TP;λ=<span class=hljs-number >1.0</span>) <span class=hljs-keyword >where</span> {TP&lt;:<span class=hljs-built_in >Number</span>}
    n = length(y_observed)
    S = <span class=hljs-number >0</span>; T = <span class=hljs-number >0</span>;
    <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:n
        S += kk(x_observed[i],x_pred,λ)*y_observed[i]
        T += kk(x_observed[i],x_pred,λ)
    <span class=hljs-keyword >end</span>
    result = T == <span class=hljs-number >0</span> ? <span class=hljs-number >0</span> : S/T
    <span class=hljs-keyword >return</span> result
<span class=hljs-keyword >end</span>
ベクトル化にも対応しています。
<span class=hljs-keyword >function</span> nadaraya_watson_estimator(x_observed::<span class=hljs-built_in >Vector</span>,y_observed::<span class=hljs-built_in >Vector</span>,kk::<span class=hljs-built_in >Function</span>,x_pred::<span class=hljs-built_in >Union</span>{<span class=hljs-built_in >Vector</span>,<span class=hljs-built_in >AbstractRange</span>};λ=<span class=hljs-number >1.0</span>)
    y_pred = [nadaraya_watson_estimator(x_observed,y_observed,kk,xp; λ) <span class=hljs-keyword >for</span> xp <span class=hljs-keyword >in</span> x_pred]
<span class=hljs-keyword >end</span></code></pre>
<p><div class=note ><div class=title >😲 Note</div>
<div class=content >epanechnikoc関数に絶対値の処理は必要になりますが、abs関数を使うよりもLinearAlgebra.jlのnormを使った方が、多次元化に対応できて良いと思います。</div></div> トイデータとしてsin関数にノイズをのせたデータを作成します。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Random
Random.seed!(<span class=hljs-number >123</span>)
n=<span class=hljs-number >250</span>;x = <span class=hljs-number >2</span>randn(n); y = sin.(<span class=hljs-number >2</span><span class=hljs-literal >π</span>*x) + randn(n)/<span class=hljs-number >4</span>

<span class=hljs-keyword >using</span> Plots
p58 = scatter(x,y,xlims=(-<span class=hljs-number >3</span>,<span class=hljs-number >3</span>),label=<span class=hljs-literal >false</span>)
xx = -<span class=hljs-number >3</span>:<span class=hljs-number >0.1</span>:<span class=hljs-number >3</span>
<span class=hljs-keyword >using</span> Joe:nadaraya_watson_estimator, epanechnikov
<span class=hljs-keyword >using</span> LinearAlgebra</code></pre>
<p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>0.05</mn><mo separator=true >,</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\lambda=0.05,0.25</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class=mord >0</span><span class=mord >.</span><span class=mord >0</span><span class=mord >5</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >0</span><span class=mord >.</span><span class=mord >2</span><span class=mord >5</span></span></span></span>の場合にプロットしてみます。</p>
<pre><code class="julia hljs">plot!(p58,xx,nadaraya_watson_estimator(x,y,epanechnikov,xx;λ=<span class=hljs-number >0.05</span>),
         label=<span class=hljs-string >&quot;λ = 0.05&quot;</span>);
plot!(p58,xx,nadaraya_watson_estimator(x,y,epanechnikov,xx;λ=<span class=hljs-number >0.25</span>),
         label=<span class=hljs-string >&quot;λ = 0.25&quot;</span>);</code></pre>
<p>クロスバリデーションで<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span></span></span></span>を最適化してプロットしてみます。</p>
<pre><code class="julia hljs">λ_seq = <span class=hljs-number >0.05</span>:<span class=hljs-number >0.01</span>:<span class=hljs-number >1</span>
SS_min = <span class=hljs-literal >Inf</span>
λ_best = λ_seq[<span class=hljs-number >1</span>]
<span class=hljs-keyword >for</span> λ <span class=hljs-keyword >in</span> λ_seq
    SS = <span class=hljs-number >0</span>
    m = <span class=hljs-built_in >Int</span>(n/<span class=hljs-number >10</span>)
    <span class=hljs-keyword >for</span> k <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >10</span>
        test = k*m-m+<span class=hljs-number >1</span>:k*m
        train = setdiff(<span class=hljs-number >1</span>:n,test)
        y_pred = nadaraya_watson_estimator(x[train],y[train],epanechnikov,x[test];λ=λ)
        SS += dot(y[test]-y_pred,y[test]-y_pred)
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >if</span> SS &lt; SS_min
        SS_min = SS
        λ_best = λ
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>

plot!(p58,xx,nadaraya_watson_estimator(x,y,epanechnikov,xx;λ=λ_best), label=<span class=hljs-string >&quot;λ = λ_best&quot;</span>)</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-10.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mrow><mi>b</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\lambda_{best}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.84444em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">λ</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>はこの程度の値になるようです。</p>
<pre><code class="julia hljs"><span class=hljs-meta >@show</span> λ_best;</code></pre><pre><code class="plaintext hljs">λ_best = 0.19
</code></pre>
<h3 id="例61_局所線形回帰"><a href="#例61_局所線形回帰">例61 局所線形回帰</a></h3>
<p>カーネル関数<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>を成分に持った対角行列<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold-italic >W</mi></mrow><annotation encoding="application/x-tex">\bm{W}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68611em;vertical-align:0em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span></span></span></span>を</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=bold-italic >W</mi><mo>=</mo><mrow><mo fence=true >[</mo><mtable rowspacing=0.15999999999999992em  columnspacing=1em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mi>k</mi><mo stretchy=false >(</mo><mi>x</mi><mo separator=true >,</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mo lspace=0em  rspace=0em >⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mi><mi mathvariant=normal >⋮</mi><mpadded height="+0em" voffset=0em ><mspace mathbackground=black  width=0em  height=1.5em ></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mo lspace=0em  rspace=0em >⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mi><mi mathvariant=normal >⋮</mi><mpadded height="+0em" voffset=0em ><mspace mathbackground=black  width=0em  height=1.5em ></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=false ><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mo lspace=0em  rspace=0em >⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=false ><mrow><mi>k</mi><mo stretchy=false >(</mo><mi>x</mi><mo separator=true >,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence=true >]</mo></mrow></mrow><annotation encoding="application/x-tex">\bm{W} = \begin{bmatrix}
 k(x,x_1) &amp; \cdots &amp; 0 \\
 \vdots &amp; \ddots &amp; \vdots \\
 0 &amp; \cdots &amp; k(x,x_n) \end{bmatrix} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68611em;vertical-align:0em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:4.260000000000001em;vertical-align:-1.8800000000000006em;"></span><span class=minner ><span class=mopen ><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.352005em;"><span style="top:-1.9499950000000004em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-3.0999950000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.1109850000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.352005em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.850025em;"><span></span></span></span></span></span></span><span class=mord ><span class=mtable ><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.3800000000000003em;"><span style="top:-5.2275em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span><span style="top:-3.3674999999999997em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord ><span class=mord >⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1674999999999995em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord >0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.8800000000000006em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.3800000000000003em;"><span style="top:-5.04em;"><span class=pstrut  style="height:3.5em;"></span><span class=mord ><span class=minner >⋯</span></span></span><span style="top:-3.1799999999999997em;"><span class=pstrut  style="height:3.5em;"></span><span class=mord ><span class=minner >⋱</span></span></span><span style="top:-1.9799999999999995em;"><span class=pstrut  style="height:3.5em;"></span><span class=mord ><span class=minner >⋯</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.8800000000000006em;"><span></span></span></span></span></span><span class=arraycolsep  style="width:0.5em;"></span><span class=arraycolsep  style="width:0.5em;"></span><span class=col-align-c ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.3800000000000003em;"><span style="top:-5.2275em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord >0</span></span></span><span style="top:-3.3674999999999997em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class=mord ><span class=mord >⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.1674999999999995em;"><span class=pstrut  style="height:3.6875em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.8800000000000006em;"><span></span></span></span></span></span></span></span><span class=mclose ><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:2.352005em;"><span style="top:-1.9499950000000004em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-3.0999950000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.1109850000000003em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.352005em;"><span class=pstrut  style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.850025em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>とした時、</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi>L</mi><mo><mi mathvariant=normal >≔</mi></mo><mo stretchy=false >(</mo><mi mathvariant=bold-italic >y</mi><mo>−</mo><mi><mrow><mi mathvariant=bold-italic >X</mi><mi mathvariant=bold-italic >β</mi></mrow></mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><msup><mo stretchy=false >)</mo><mi mathvariant=sans-serif >T</mi></msup><mi mathvariant=bold-italic >W</mi><mo stretchy=false >(</mo><mi mathvariant=bold-italic >y</mi><mo>−</mo><mi><mrow><mi mathvariant=bold-italic >X</mi><mi mathvariant=bold-italic >β</mi></mrow></mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex"> L \coloneqq (\bm{y} - \bm{Xβ}(x))^\mathsf{T}\bm{W}(\bm{y} - \bm{Xβ}(x)) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel ><span class=mrel ><span class=mop  style="position:relative;top:-0.03472em;">:</span></span><span class=mrel ><span class=mspace  style="margin-right:-0.06666666666666667em;"></span></span><span class=mrel >=</span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.149108em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mclose >)</span></span></span></span></span>
<p>を最小化する<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=bold-italic >β</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">\bm{\beta}(x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>を求めます。</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mfrac><mrow><mi mathvariant=normal >∂</mi><mi>L</mi></mrow><mrow><mi mathvariant=normal >∂</mi><mi mathvariant=bold-italic >β</mi></mrow></mfrac><mo>=</mo><mo>−</mo><mn>2</mn><msup><mi mathvariant=bold-italic >X</mi><mi mathvariant=sans-serif >T</mi></msup><mi mathvariant=bold-italic >W</mi><mo stretchy=false >(</mo><mi mathvariant=bold-italic >y</mi><mo>−</mo><mi><mrow><mi mathvariant=bold-italic >X</mi><mi mathvariant=bold-italic >β</mi></mrow></mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex"> \dfrac{\partial L}{\partial \bm{\beta}} =
-2\bm{X}^\mathsf{T}\bm{W}(\bm{y} - \bm{Xβ}(x))=0</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:2.25188em;vertical-align:-0.8804400000000001em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">L</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.1751179999999999em;vertical-align:-0.25em;"></span><span class=mord >−</span><span class=mord >2</span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9251179999999999em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span></span></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >0</span></span></span></span></span>
<p>とおくと、</p>
<span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=bold-italic >β</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>=</mo><mo stretchy=false >(</mo><msup><mi mathvariant=bold-italic >X</mi><mi mathvariant=sans-serif >T</mi></msup><mi><mrow><mi mathvariant=bold-italic >W</mi><mi mathvariant=bold-italic >X</mi></mrow></mi><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msup><mi mathvariant=bold-italic >X</mi><mi mathvariant=sans-serif >T</mi></msup><mi><mrow><mi mathvariant=bold-italic >W</mi><mi mathvariant=bold-italic >y</mi></mrow></mi></mrow><annotation encoding="application/x-tex"> \bm{\beta}(x) = (\bm{X}^\mathsf{T}\bm{WX})^{-1}\bm{X}^\mathsf{T}\bm{Wy}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.03403em;">β</span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.1751179999999999em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9251179999999999em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.07778em;">X</span></span></span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.9251179999999999em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class=mord ><span class=mord ><span class="mord boldsymbol" style="margin-right:0.15972em;">W</span><span class="mord boldsymbol" style="margin-right:0.03704em;">y</span></span></span></span></span></span></span>
<p>で係数を求めることができます。この処理を関数で実装するわけですが、原著のlocalという関数名は良くないので、 local_regressionという名前で実装しました。例では1次元に限定していましたが、 多次元データにも対応させています。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> local_regression(x::<span class=hljs-built_in >Matrix</span>{T},
                          y::<span class=hljs-built_in >Vector</span>{T},
                          kernel::<span class=hljs-built_in >Function</span>;
                          x_pred=x, λ=<span class=hljs-number >1</span>) <span class=hljs-keyword >where</span> {T&lt;:<span class=hljs-built_in >Number</span>}
    N,_ = size(x)
    <span class=hljs-meta >@assert</span> N==length(y)
    X = insert_ones(x)
    m,_ = size(x_pred)
    y_pred = <span class=hljs-built_in >Vector</span>{T}(<span class=hljs-literal >undef</span>,m)
    <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:m
        W = [kernel(x[i,:],x_pred[j,:],λ) <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:N] |&gt; diagm
        β̂ = (X&#x27;*W*X)\X&#x27;*W*y
        y_pred[j] = dot(insert_ones(x_pred[j,:]),β̂)
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> y_pred
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >function</span> local_regression(x::<span class=hljs-built_in >Vector</span>{T}, y::<span class=hljs-built_in >Vector</span>{T},kernel::<span class=hljs-built_in >Function</span>;x_pred=x,λ=<span class=hljs-number >1</span>) <span class=hljs-keyword >where</span> {T&lt;:<span class=hljs-built_in >Number</span>}
    <span class=hljs-keyword >return</span> local_regression(x[:,:],y,kernel;x_pred=x_pred[:,:],λ=λ)
<span class=hljs-keyword >end</span></code></pre>
<p>トイデータとしてsin関数にノイズをのせたデータを作成します。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Random,Joe
Random.seed!(<span class=hljs-number >123</span>)
n=<span class=hljs-number >30</span>; x = <span class=hljs-number >2</span><span class=hljs-literal >π</span>*rand(n) .- <span class=hljs-literal >π</span>; y = sin.(x) .+ randn()
p61 = scatter(x,y,label=<span class=hljs-literal >false</span>)
m = <span class=hljs-number >200</span>;U = -<span class=hljs-literal >π</span>:<span class=hljs-literal >π</span>/m:<span class=hljs-literal >π</span>;</code></pre>
<p>正則化パラメータ<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\lambda=1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">λ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>の条件で回帰分析を行ってプロットします。</p>
<pre><code class="julia hljs">V = Joe.local_regression(x,y,Joe.epanechnikov;x_pred=U)
plot!(p61,U,V,label=<span class=hljs-literal >false</span>,title = <span class=hljs-string >&quot;局所線形回帰(p=1, N=30)&quot;</span>)</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-11.svg" alt=""> <div class=blank ></div> 予測したい場所の数だけ回帰分析の計算を行わないといけないので、元データの数が多い時は 計算が大変そうです。</p>
<h2 id="一般化加法モデル"><a href="#一般化加法モデル">一般化加法モデル</a></h2>
<h3 id="例62"><a href="#例62">例62</a></h3>
<p>基底関数の数が有限個なら線形回帰の手法で係数を求められるけど、 数が多すぎると逆行列を解くのが大変でどうしましょうとい３う話。 バックフィッティングは例63で実装します。</p>
<h3 id="例63"><a href="#例63">例63</a></h3>
<p>以下のようなpolyfit関数を実装しました。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >function</span> polyfit(x,y;x_pred=x, P::<span class=hljs-built_in >Int</span>=<span class=hljs-number >3</span>)
    X = polynomial(x,P)
    X_pred=polynomial(x_pred,P)
    β̂ = multiple_regression(X,y)
    y_pred = insert_ones(X_pred) * β̂
<span class=hljs-keyword >end</span></code></pre>
<p><a href="#例61">例６１</a>のデータに一般加法モデルを適用します。 先に多項式でフィッティングして残りを局所線形回帰で求めていきます。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Random,Joe
Random.seed!(<span class=hljs-number >123</span>)
n=<span class=hljs-number >30</span>; x = <span class=hljs-number >2</span><span class=hljs-literal >π</span>*rand(n) .- <span class=hljs-literal >π</span>; sort!(x); y = sin.(x) .+ randn()
y₁ = zeros(n); y₂ = zeros(n)
<span class=hljs-keyword >for</span> k <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >10</span>
    y₁ = Joe.polyfit(x,y-y₂)
    y₂ = Joe.local_regression(x,y-y₁,Joe.epanechnikov)
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >using</span> Plots
p62_1 = plot(x,y₁,label=<span class=hljs-literal >false</span>,xlabel=<span class=hljs-string >&quot;x&quot;</span>,ylabel=<span class=hljs-string >&quot;f(x)&quot;</span>,title=<span class=hljs-string >&quot;多項式回帰(3次)&quot;</span>)
p62_2 = plot(x,y₂,label=<span class=hljs-literal >false</span>,xlabel=<span class=hljs-string >&quot;x&quot;</span>,ylabel=<span class=hljs-string >&quot;f(x)&quot;</span>,title=<span class=hljs-string >&quot;局所線形回帰&quot;</span>)
p62　= plot(p62_1,p62_2,layout=(<span class=hljs-number >1</span>,<span class=hljs-number >2</span>))</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-12.svg" alt=""> <div class=blank ></div> 大体３次多項式で回帰されていて、残りが局所線形回帰されていることが分かります。 先に3次多項式で回帰したためでしょうか。 確認してみることにします。</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Random,Joe
Random.seed!(<span class=hljs-number >123</span>)
n=<span class=hljs-number >30</span>; x = <span class=hljs-number >2</span><span class=hljs-literal >π</span>*rand(n) .- <span class=hljs-literal >π</span>; sort!(x); y = sin.(x) .+ randn()
y₁ = zeros(n); y₂ = zeros(n)
<span class=hljs-keyword >using</span> Plots
<span class=hljs-keyword >for</span> k <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >10</span>
    y₂ = Joe.local_regression(x,y-y₁,Joe.epanechnikov)
    y₁ = Joe.polyfit(x,y-y₂)
<span class=hljs-keyword >end</span>
p62_3 = plot(x,y₁,label=<span class=hljs-literal >false</span>,xlabel=<span class=hljs-string >&quot;x&quot;</span>,ylabel=<span class=hljs-string >&quot;f(x)&quot;</span>,title=<span class=hljs-string >&quot;多項式回帰(3次)&quot;</span>)
p62_4 = plot(x,y₂,label=<span class=hljs-literal >false</span>,xlabel=<span class=hljs-string >&quot;x&quot;</span>,ylabel=<span class=hljs-string >&quot;f(x)&quot;</span>,title=<span class=hljs-string >&quot;局所線形回帰&quot;</span>)
p62_5　= plot(p62_3,p62_4,layout=(<span class=hljs-number >1</span>,<span class=hljs-number >2</span>))</code></pre>
<p><img src="/Joe.jl/assets/StatisticalML/chap6/code/output/fig6-12-2.svg" alt=""> <div class=blank ></div> 多項式回帰の影響が減って、局所線形回帰の成分が大きくなることが確認できました。</p>
  <p style="text-align:right">  めでたしめでたし </p>  <button onclick="topFunction()" id=myBtn  title="Go to top">Top</button> </p>
<div class=page-foot >
  <div class=copyright >
    &copy; Kei Hanafusa. Last modified: January 03, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
  </main> 
  <script src="/Joe.jl/libs/vela/metisMenu.min.js"></script>
  <script src="/Joe.jl/libs/vela/slideout.min.js"></script>
  <script src="/Joe.jl/libs/myBtn/myBtn.js"></script>
  <script src="/Joe.jl/libs/popup/jquery.magnific-popup.min.js"></script>
  <script src="/Joe.jl/libs/popup/mypopup.js"></script>