<!doctype html> <html lang=ja > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/Joe.jl/libs/katex/katex.min.css"> <link rel=stylesheet  href="/Joe.jl/libs/highlight/github.min.css"> <link href="/Joe.jl/css/franklin.css" rel=stylesheet > <link href="/Joe.jl/css/vela.css" rel=stylesheet > <script src="/Joe.jl/libs/vela/jquery.min.js"></script> <link rel=icon  href="/Joe.jl/assets/favicon.ico"> <title>機械学習の数理100問をjuliaでやる </title> <div class=main-nav  id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>機械学習の数理100問</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/Joe.jl/index.html">トップ</a> <li><a href="" class=has-arrow >統計的機械学習の数理100問</a> <ul> <li><a href="/Joe.jl/StatisticalML/chap1/">第一章　線形回帰</a> <li><a href="/Joe.jl/StatisticalML/chap2/">第二章　分類</a> <li><a href="/Joe.jl/StatisticalML/chap3/">第三章　リサンプリング</a> <li><a href="/Joe.jl/StatisticalML/chap4/">第四章　情報量基準</a> <li><a href="/Joe.jl/StatisticalML/chap5/">第五章　正則化</a> <li><a href="/Joe.jl/StatisticalML/chap6/">第五章　非線形回帰</a> </ul> <li><a href="" class=has-arrow >スパース推定100問</a> <ul> <li> </ul> </ul> </nav> </div> <main id=panel > <div class="toggle-button hamburger hamburger--spin"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">リサンプリング</h1> <hr> <div class=franklin-content ><p><div class=franklin-toc ><ol><li><a href="#クロスバリデーション">クロスバリデーション</a><ol><li><a href="#例39">例39</a><li><a href="#例40">例40</a><li><a href="#例41_finsherのあやめ">例41 &#40;FInsherのあやめ&#41;</a></ol><li><a href="#線形回帰の場合の公式cvの公式">線形回帰の場合の公式&#40;CVの公式&#41;</a><li><a href="#ブートストラップ">ブートストラップ</a><ol><li><a href="#例43">例43</a><li><a href="#例44">例44</a></ol></ol></div> <h2 id="クロスバリデーション"><a href="#クロスバリデーション">クロスバリデーション</a></h2> <p>まず線形回帰の場合のクロスバリデーションの関数を定義します。</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> cv_linear(X::<span class=hljs-built_in >AbstractArray</span>,y::<span class=hljs-built_in >Vector</span>,K::<span class=hljs-built_in >Int</span>)
    n = length(y); m = round(<span class=hljs-built_in >Int</span>,n/K)
    S = <span class=hljs-number >0</span>
    <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:K
        test = j*m-m+<span class=hljs-number >1</span>:j*m
        train = setdiff(<span class=hljs-number >1</span>:n,test)
        β̂ = multiple_regression(X[train,:],y[train])
        ŷ = insert_ones(X[test,:])*β̂
        S += dot(y[test]-ŷ,y[test]-ŷ)
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> S/n
<span class=hljs-keyword >end</span></code></pre> <h3 id="例39"><a href="#例39">例39</a></h3> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Joe, Random, Plots
<span class=hljs-keyword >using</span> Joe: cv_linear
n = <span class=hljs-number >100</span>; p = <span class=hljs-number >5</span>
Random.seed!(<span class=hljs-number >1</span>)
X = randn(n, p)
β = randn(p+<span class=hljs-number >1</span>); β[<span class=hljs-number >2</span>:<span class=hljs-number >3</span>] .= <span class=hljs-number >0</span>
y = insert_ones(X)*β + randn(n)
<span class=hljs-meta >@show</span> cv_linear(X[:,[<span class=hljs-number >3</span>,<span class=hljs-number >4</span>,<span class=hljs-number >5</span>]],y,<span class=hljs-number >10</span>);
<span class=hljs-meta >@show</span> cv_linear(X,y,<span class=hljs-number >10</span>);</code></pre><pre><code class="plaintext hljs">cv_linear(X[:, [3, 4, 5]], y, 10) = 0.7113670647592754
cv_linear(X, y, 10) = 0.6995149878356592
</code></pre> <p>あれ？変数選択した方が誤差でかいぞ？試行回数を増やして全変数を用いた場合のCV値と 変数選択を行った場合のCV値を可視化します。</p> <pre><code class="julia hljs">U=<span class=hljs-built_in >Float64</span>[]; V = <span class=hljs-built_in >Float64</span>[]
<span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >100</span>
    y = insert_ones(X)*β + randn(n)
    push!(U,cv_linear(X[:,[<span class=hljs-number >3</span>,<span class=hljs-number >4</span>,<span class=hljs-number >5</span>]],y,<span class=hljs-number >10</span>))
    push!(V,cv_linear(X,y,<span class=hljs-number >10</span>))
<span class=hljs-keyword >end</span>

p39 = scatter(U,V,xlabel=<span class=hljs-string >&quot;変数4,5,6を選んだ時の二乗誤差&quot;</span>,
                ylabel=<span class=hljs-string >&quot;全変数を選んだ時の二乗誤差&quot;</span>,
                title=<span class=hljs-string >&quot;変数を多く選びすぎて過学習&quot;</span>)
plot!(p39, x-&gt;x,xlims=(<span class=hljs-number >0.7</span>,<span class=hljs-number >1.5</span>),legend=<span class=hljs-literal >false</span>)</code></pre> <p><img src="/Joe.jl/assets/StatisticalML/chap3/code/output/fig3-1.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">y=x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> の直線の上側に大多数の点がプロットされているので、 変数選択をした方が誤差が少ないことが分かりました。 ただ、あまり二乗誤差の違いは大きくないです。</p> <h3 id="例40"><a href="#例40">例40</a></h3> <p>kの値を変えたときのCVの予測誤差の変化</p> <pre><code class="julia hljs">n = <span class=hljs-number >100</span>; p = <span class=hljs-number >5</span>;
p40 = plot(ylims=(<span class=hljs-number >0.3</span>,<span class=hljs-number >1.5</span>),xlabel=<span class=hljs-string >&quot;k&quot;</span>,ylabel=<span class=hljs-string >&quot;CVの値&quot;</span>,
            title=<span class=hljs-string >&quot;k-foldのkとCVの値の関係&quot;</span>,legend=<span class=hljs-literal >false</span>)
Random.seed!(<span class=hljs-number >1</span>)
<span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >10</span>
    X = randn(n,p)
    β = randn(p+<span class=hljs-number >1</span>)
    y = insert_ones(X) * β + randn(n)
    U = <span class=hljs-built_in >Int</span>[]
    V = <span class=hljs-built_in >Float64</span>[]
    <span class=hljs-keyword >for</span> k <span class=hljs-keyword >in</span> <span class=hljs-number >2</span>:n
        <span class=hljs-keyword >if</span> n%k==<span class=hljs-number >0</span>
            push!(U,k)
            push!(V, cv_linear(X,y,k))
        <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >end</span>
    plot!(p40,U,V)
<span class=hljs-keyword >end</span></code></pre> <img src="/Joe.jl/assets/StatisticalML/chap3/code/output/fig3-2.svg" alt=""> <h3 id="例41_finsherのあやめ"><a href="#例41_finsherのあやめ">例41 &#40;FInsherのあやめ&#41;</a></h3> <p>あやめのデータセットでK近傍法のｋ毎に誤り率を評価します。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> RDatasets, StatsBase, Random, Plots
<span class=hljs-keyword >using</span> Joe:knn
iris = dataset(<span class=hljs-string >&quot;datasets&quot;</span>,<span class=hljs-string >&quot;iris&quot;</span>)
X = iris[!,<span class=hljs-number >1</span>:<span class=hljs-number >4</span>] |&gt; <span class=hljs-built_in >Matrix</span>
targets=unique(iris.Species);</code></pre> <p>あやめの種類をIntに変換します。</p> <pre><code class="julia hljs">label = <span class=hljs-built_in >Dict</span>(target=&gt;i <span class=hljs-keyword >for</span> (i,target) <span class=hljs-keyword >in</span> enumerate(targets))
y = [label[i] <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> iris.Species];
n = length(y);</code></pre> <p>データセットをランダムに並べ替えておきます。</p> <pre><code class="julia hljs">Random.seed!(<span class=hljs-number >1</span>)
order = sample(<span class=hljs-number >1</span>:n,n,replace=<span class=hljs-literal >false</span>)
X = X[order,:]; y = y[order];</code></pre> <p>10-foldクロスバリデーションなので、テストデータを15毎に交代させることになります。</p> <pre><code class="julia hljs">errorRate = <span class=hljs-built_in >Vector</span>{<span class=hljs-built_in >Float64</span>}(<span class=hljs-literal >undef</span>,<span class=hljs-number >10</span>)
<span class=hljs-keyword >for</span> k <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >10</span>
    S = <span class=hljs-number >0</span>
    <span class=hljs-keyword >for</span> top <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >15</span>:<span class=hljs-number >150</span>
        test = top:top+<span class=hljs-number >14</span>
        train = setdiff(<span class=hljs-number >1</span>:<span class=hljs-number >150</span>,test)
        knn_ans = knn(X[train,:],y[train],X[test,:],k)
        S += sum(y[test] .!= knn_ans)
    <span class=hljs-keyword >end</span>
    S /= n
    errorRate[k] = S
<span class=hljs-keyword >end</span>
p41 = plot(errorRate,xlabel=<span class=hljs-string >&quot;K&quot;</span>,ylabel=<span class=hljs-string >&quot;誤り率&quot;</span>,
            legend=<span class=hljs-literal >false</span>, title=<span class=hljs-string >&quot;CVによる誤り率の評価&quot;</span>)</code></pre> <p><img src="/Joe.jl/assets/StatisticalML/chap3/code/output/fig3-3.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>≥</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">K \ge 3</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8193em;vertical-align:-0.13597em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≥</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >3</span></span></span></span>で大きく誤り率が低下することが分かりました。 pythonでは実行に10分程度かかったとありますが、いくらなんでも遅すぎでは？&#40;juliaは瞬殺&#41;</p> <h2 id="線形回帰の場合の公式cvの公式"><a href="#線形回帰の場合の公式cvの公式">線形回帰の場合の公式&#40;CVの公式&#41;</a></h2> <p>クロスバリデーションでの誤差の分析は、訓練データ毎に重回帰分析を行う必要があるので、 処理に時間がかかります。<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent=true ><mi>β</mi><mo>^</mo></mover><mrow><mo>−</mo><mi>S</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\hat{\beta}_{-S}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.1662109999999999em;vertical-align:-0.208331em;"></span><span class=mord ><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.9578799999999998em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.16666em;"><span class=mord >^</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.19444em;"><span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>をあらわに求めることなく、CVを 楽して評価できるのがこの公式です。&#40;<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>はテストデータの集合、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">-S</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.76666em;vertical-align:-0.08333em;"></span><span class=mord >−</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>は訓練データの集合&#41; <div class=blank ></div></p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><munder><mo>∑</mo><mi>S</mi></munder><mi mathvariant=normal >∣</mi><mi mathvariant=normal >∣</mi><mo stretchy=false >(</mo><mi>I</mi><mo>−</mo><msub><mi>H</mi><mi>S</mi></msub><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>e</mi><mi>S</mi></msub><mi mathvariant=normal >∣</mi><msup><mi mathvariant=normal >∣</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sum_{S} || (I - H_S)^{-1}e_S||^2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:2.344341em;vertical-align:-1.294336em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.0500050000000003em;"><span style="top:-1.855664em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span style="top:-3.050005em;"><span class=pstrut  style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.294336em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >∣</span><span class=mord >∣</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >∣</span><span class=mord ><span class=mord >∣</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> <p>ただし、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>S</mi></msub><mo>=</mo><msub><mi>X</mi><mi>S</mi></msub><mo stretchy=false >(</mo><msup><mi>X</mi><mi mathvariant=sans-serif >T</mi></msup><mi>X</mi><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>S</mi><mi mathvariant=sans-serif >T</mi></msubsup></mrow><annotation encoding="application/x-tex">H_S = X_S(X^\mathsf{T}X)^{-1}X_S^\mathsf{T}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.124439em;vertical-align:-0.275331em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.849108em;"><span style="top:-2.424669em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.275331em;"><span></span></span></span></span></span></span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>S</mi></msub><mo>=</mo><msub><mi>y</mi><mi>S</mi></msub><mo>−</mo><msub><mi>X</mi><mi>S</mi></msub><mover accent=true ><mi>β</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">e_S = y_S - X_S\hat{\beta}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1523199999999998em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.9578799999999998em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.16666em;"><span class=mord >^</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.19444em;"><span></span></span></span></span></span></span></span></span> です。プログラムを実装して、ベンチマークをしてみます。 cv_fast関数は次のように実装しました。</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> cv_fast(X::<span class=hljs-built_in >AbstractArray</span>,y::<span class=hljs-built_in >Vector</span>,K::<span class=hljs-built_in >Int</span>)
    n = length(y); m = round(<span class=hljs-built_in >Int</span>,n/K)
    X = insert_ones(X)
    H = X*((X&#x27;X)\X&#x27;)
    e = (I(n) - H)*y
    S = <span class=hljs-number >0</span>
    <span class=hljs-meta >@views</span> <span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:K
        test = j*m-m+<span class=hljs-number >1</span>:j*m;
        err = (I(m)-H[test,test]) \ e[test]
        S += dot(err,err)
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> S/n
<span class=hljs-keyword >end</span></code></pre> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Joe, Random, Plots
<span class=hljs-keyword >using</span> Joe:cv_linear,cv_fast

n = <span class=hljs-number >1000</span>; p = <span class=hljs-number >5</span>
Random.seed!(<span class=hljs-number >1</span>)
X = randn(n, p)
β = randn(p+<span class=hljs-number >1</span>); β[<span class=hljs-number >2</span>:<span class=hljs-number >3</span>] .= <span class=hljs-number >0</span>
y = insert_ones(X)*β + randn(n);</code></pre> <p>ループのネストを浅くしたいので、K-foldのkのリストを作って、ループすることにします。</p> <pre><code class="julia hljs">K = [i <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >2</span>:<span class=hljs-number >1000</span> <span class=hljs-keyword >if</span> <span class=hljs-number >1000</span>%i ==<span class=hljs-number >0</span>]
t_linear = <span class=hljs-built_in >Vector</span>{<span class=hljs-built_in >Float64</span>}(<span class=hljs-literal >undef</span>,length(K));
t_fast = similar(t_linear);</code></pre> <p>まずは関数の慣らし運転を</p> <pre><code class="julia hljs"><span class=hljs-meta >@show</span> cv_linear(X,y,<span class=hljs-number >10</span>)
<span class=hljs-meta >@show</span> cv_fast(X,y,<span class=hljs-number >10</span>)</code></pre><pre><code class="plaintext hljs">cv_linear(X, y, 10) = 0.998850226625682
cv_fast(X, y, 10) = 0.9988502266256818
</code></pre> <p>値が一致することは確認できました。それでは、いざ本番&#33;</p> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> eachindex(K)
    start = time_ns();cv_fast(X,y,K[i]);stop = time_ns()
    t_fast[i] = (stop-start)/<span class=hljs-number >1e9</span>
    start = time_ns();cv_linear(X,y,K[i]);stop = time_ns()
    t_linear[i] = (stop-start)/<span class=hljs-number >1e9</span>
<span class=hljs-keyword >end</span>
p42 = plot(ylims=(<span class=hljs-number >0.0</span>,<span class=hljs-number >0.5</span>), xlabel = <span class=hljs-string >&quot;k&quot;</span> ,ylabel=<span class=hljs-string >&quot;実行時間&quot;</span>,
           label=<span class=hljs-string >&quot;cv_linear&quot;</span>,title=<span class=hljs-string >&quot;cv_fastとcv_linearの比較&quot;</span>,
           legend=:topleft)
plot!(p42,K, t_linear, label=<span class=hljs-string >&quot;cv_linear&quot;</span>)
plot!(p42,K, t_fast, label=<span class=hljs-string >&quot;cv_fast&quot;</span>)</code></pre> <p><img src="/Joe.jl/assets/StatisticalML/chap3/code/output/fig3-4.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>≥</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">n\ge100</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">n</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≥</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span></span></span></span>ではcv_fastの方が実行時間が短いことが分かります。 原著と比べると、マシンの違いがあるとはいえ、juliaは速いということもよくわかります。</p> <h2 id="ブートストラップ"><a href="#ブートストラップ">ブートストラップ</a></h2> <p>以下のような複合型とbootstrap関数を定義しました。 原著のコードよりは可読性が向上したかなぁ。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Parameters
<span class=hljs-meta >@with_kw</span> <span class=hljs-keyword >mutable struct</span> bt{T&lt;:<span class=hljs-built_in >Number</span>}
    original::T = <span class=hljs-number >0</span>
    bias::T = <span class=hljs-number >0</span>
    <span class=hljs-literal >stderr</span>::T = <span class=hljs-number >0</span>
<span class=hljs-keyword >end</span>
<span class=hljs-keyword >function</span> bootstrap(df::<span class=hljs-built_in >AbstractArray</span>{T}, F::<span class=hljs-built_in >Function</span>, r::<span class=hljs-built_in >Int</span>) <span class=hljs-keyword >where</span> T &lt;:<span class=hljs-built_in >Number</span>
    m,_ = size(df)
    original = F(df,<span class=hljs-number >1</span>:m)
    u = <span class=hljs-built_in >Vector</span>{T}(<span class=hljs-literal >undef</span>, r)
    <span class=hljs-keyword >for</span> i <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:r
        index = sample(<span class=hljs-number >1</span>:m,m,replace=<span class=hljs-literal >true</span>)
        u[i] = F(df,index)
    <span class=hljs-keyword >end</span>
    bias = mean(u) - original; <span class=hljs-literal >stderr</span> = std(u)
    result = bt()
    <span class=hljs-meta >@pack</span>! result = original, bias, <span class=hljs-literal >stderr</span>
<span class=hljs-keyword >end</span></code></pre> <h3 id="例43"><a href="#例43">例43</a></h3> <p>データは<a href="https://bitbucket.org/prof-joe/statistical_learning_with_python/src/master/">ここ</a>からダウンロードできます。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> DelimitedFiles, Statistics
<span class=hljs-keyword >using</span> Joe:bootstrap
<span class=hljs-keyword >function</span> func_1(data,index)
    X=data[index,<span class=hljs-number >1</span>]; Y= data[index,<span class=hljs-number >2</span>]
    (var(Y) - var(X))/(var(X) + var(Y) -<span class=hljs-number >2</span>cov(X,Y))
<span class=hljs-keyword >end</span>
Portfolio = readdlm(joinpath(<span class=hljs-string >&quot;_assets&quot;</span>,<span class=hljs-string >&quot;data&quot;</span>,<span class=hljs-string >&quot;Portfolio.csv&quot;</span>),<span class=hljs-string >&#x27;,&#x27;</span>, skipstart=<span class=hljs-number >1</span>)
bootstrap(Portfolio,func_1,<span class=hljs-number >1000</span>)</code></pre><pre><code class="plaintext hljs">Joe.bt{Float64}
  original: Float64 0.15166414929676278
  bias: Float64 -0.0032877554675548593
  stderr: Float64 0.1834211386694929
</code></pre> <h3 id="例44"><a href="#例44">例44</a></h3> <p>データの読み込み</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Joe,DelimitedFiles
df = readdlm(joinpath(<span class=hljs-string >&quot;_assets&quot;</span>,<span class=hljs-string >&quot;data&quot;</span>,<span class=hljs-string >&quot;crime.txt&quot;</span>))
X = df[:,<span class=hljs-number >3</span>:<span class=hljs-number >4</span>]; y =df[:,<span class=hljs-number >1</span>]
β = multiple_regression(X,y)</code></pre><pre><code class="plaintext hljs">3-element Array{Float64,1}:
 621.4260363802932
  11.858330796711074
  -5.973411688165022</code></pre> <p>回帰係数のそれぞれについて、ブートストラップ法を適用します。ここでは標準偏差だけを出力します。</p> <pre><code class="julia hljs">std_bt = ones(<span class=hljs-number >3</span>)
<span class=hljs-keyword >for</span> j <span class=hljs-keyword >in</span> <span class=hljs-number >1</span>:<span class=hljs-number >3</span>
    <span class=hljs-keyword >function</span> func_2(data,index)
        X = data[index,<span class=hljs-number >3</span>:<span class=hljs-number >4</span>];y = data[index,<span class=hljs-number >1</span>]
        β = multiple_regression(X,y)
        <span class=hljs-keyword >return</span> β[j]
    <span class=hljs-keyword >end</span>
    std_bt[j] = bootstrap(df,func_2,<span class=hljs-number >1000</span>).<span class=hljs-literal >stderr</span>
<span class=hljs-keyword >end</span>
std_bt</code></pre><pre><code class="plaintext hljs">3-element Array{Float64,1}:
 215.15343849735987
   3.46830278356897
   3.3856685822145383</code></pre> <p>GLM.jlで回帰係数を推定したときの標準偏差と比較してみます。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> GLM, DataFrames
data = DataFrame(df)
ols = lm(<span class=hljs-meta >@formula</span>(x1 ~ x3 + x4), data)</code></pre><pre><code class="plaintext hljs">StatsModels.TableRegressionModel{GLM.LinearModel{GLM.LmResp{Array{Float64,1}},GLM.DensePredChol{Float64,LinearAlgebra.Cholesky{Float64,Array{Float64,2}}}},Array{Float64,2}}

x1 ~ 1 + x3 + x4

Coefficients:
──────────────────────────────────────────────────────────────────────────
                 Coef.  Std. Error      t  Pr(&gt;|t|)  Lower 95%   Upper 95%
──────────────────────────────────────────────────────────────────────────
(Intercept)  621.426     222.685     2.79    0.0076  173.441    1069.41
x3            11.8583      2.568     4.62    &lt;1e-4     6.69219    17.0245
x4            -5.97341     3.56144  -1.68    0.1001  -13.1381      1.19129
──────────────────────────────────────────────────────────────────────────</code></pre> <p>標準偏差がほぼ一致することが分かりました。</p> <p style="text-align:right"> めでたしめでたし </p> <button onclick="topFunction()" id=myBtn  title="Go to top">Top</button> </p> <div class=page-foot > <div class=copyright > &copy; Kei Hanafusa. Last modified: December 30, 2020. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </main> <script src="/Joe.jl/libs/vela/metisMenu.min.js"></script> <script src="/Joe.jl/libs/vela/slideout.min.js"></script> <script src="/Joe.jl/libs/myBtn/myBtn.js"></script>