<!doctype html> <html lang=ja > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/Joe.jl/libs/katex/katex.min.css"> <link rel=stylesheet  href="/Joe.jl/libs/highlight/github.min.css"> <link rel=stylesheet  href="css/magnific-popup.css" /> <link href="/Joe.jl/css/franklin.css" rel=stylesheet > <link href="/Joe.jl/css/vela.css" rel=stylesheet > <script src="/Joe.jl/libs/vela/jquery.min.js"></script> <link rel=icon  href="/Joe.jl/assets/favicon.ico"> <title>機械学習の数理100問をjuliaでやる </title> <div class=main-nav  id=menu > <div class=flex-container > <span class=sidebar-brand > <h3 style='font-size: 25px'>機械学習の数理100問</h3> </span> </div> <nav class=sidebar-nav > <ul class=metismenu  id=metismenu  > <li><a href="/Joe.jl/index.html">トップ</a> <li><a href="" class=has-arrow >統計的機械学習の数理100問</a> <ul> <li><a href="/Joe.jl/StatisticalML/chap1/">第一章　線形回帰</a> <li><a href="/Joe.jl/StatisticalML/chap2/">第二章　分類</a> <li><a href="/Joe.jl/StatisticalML/chap3/">第三章　リサンプリング</a> <li><a href="/Joe.jl/StatisticalML/chap4/">第四章　情報量基準</a> <li><a href="/Joe.jl/StatisticalML/chap5/">第五章　正則化</a> <li><a href="/Joe.jl/StatisticalML/chap6/">第六章　非線形回帰</a> <li><a href="/Joe.jl/StatisticalML/chap7/">第七章　決定木</a> </ul> <li><a href="" class=has-arrow >スパース推定100問</a> <ul> <li> </ul> </ul> </nav> </div> <main id=panel > <div class="toggle-button hamburger hamburger--spin"> <div class=hamburger-box > <div class=hamburger-inner ></div> </div> </div> <h1 class="page title">リサンプリング</h1> <hr> <div class=franklin-content ><p><div class=franklin-toc ><ol><li><a href="#クロスバリデーション">クロスバリデーション</a><ol><li><a href="#例39">例39</a><li><a href="#例40">例40</a><li><a href="#例41_finsherのあやめ">例41 &#40;FInsherのあやめ&#41;</a></ol><li><a href="#線形回帰の場合の公式cvの公式">線形回帰の場合の公式&#40;CVの公式&#41;</a><li><a href="#ブートストラップ">ブートストラップ</a><ol><li><a href="#例43">例43</a><li><a href="#例44">例44</a></ol></ol></div> <h2 id="クロスバリデーション"><a href="#クロスバリデーション" class=header-anchor >クロスバリデーション</a></h2> <p>まず線形回帰の場合のクロスバリデーションの関数を定義します。</p> <pre><code class=language-julia >function cv_linear&#40;X::AbstractArray,y::Vector,K::Int&#41;
    n &#61; length&#40;y&#41;; m &#61; round&#40;Int,n/K&#41;
    S &#61; 0
    for j in 1:K
        test &#61; j*m-m&#43;1:j*m
        train &#61; setdiff&#40;1:n,test&#41;
        β̂ &#61; multiple_regression&#40;X&#91;train,:&#93;,y&#91;train&#93;&#41;
        ŷ &#61; insert_ones&#40;X&#91;test,:&#93;&#41;*β̂
        S &#43;&#61; dot&#40;y&#91;test&#93;-ŷ,y&#91;test&#93;-ŷ&#41;
    end
    return S/n
end</code></pre> <h3 id="例39"><a href="#例39" class=header-anchor >例39</a></h3> <pre><code class=language-julia >using Joe, Random, Plots
using Joe: cv_linear
n &#61; 100; p &#61; 5
Random.seed&#33;&#40;1&#41;
X &#61; randn&#40;n, p&#41;
β &#61; randn&#40;p&#43;1&#41;; β&#91;2:3&#93; .&#61; 0
y &#61; insert_ones&#40;X&#41;*β &#43; randn&#40;n&#41;
@show cv_linear&#40;X&#91;:,&#91;3,4,5&#93;&#93;,y,10&#41;;
@show cv_linear&#40;X,y,10&#41;;</code></pre><pre><code class="plaintext code-output">cv_linear(X[:, [3, 4, 5]], y, 10) = 0.7113670647592754
cv_linear(X, y, 10) = 0.6995149878356592
</code></pre> <p>あれ？変数選択した方が誤差でかいぞ？試行回数を増やして全変数を用いた場合のCV値と 変数選択を行った場合のCV値を可視化します。</p> <pre><code class=language-julia >U&#61;Float64&#91;&#93;; V &#61; Float64&#91;&#93;
for _ in 1:100
    y &#61; insert_ones&#40;X&#41;*β &#43; randn&#40;n&#41;
    push&#33;&#40;U,cv_linear&#40;X&#91;:,&#91;3,4,5&#93;&#93;,y,10&#41;&#41;
    push&#33;&#40;V,cv_linear&#40;X,y,10&#41;&#41;
end

p39 &#61; scatter&#40;U,V,xlabel&#61;&quot;変数4,5,6を選んだ時の二乗誤差&quot;,
                ylabel&#61;&quot;全変数を選んだ時の二乗誤差&quot;,
                title&#61;&quot;変数を多く選びすぎて過学習&quot;&#41;
plot&#33;&#40;p39, x-&gt;x,xlims&#61;&#40;0.7,1.5&#41;,legend&#61;false&#41;</code></pre> <p><img src="/Joe.jl/assets/StatisticalML/chap3/code/output/fig3-1.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">y=x</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> の直線の上側に大多数の点がプロットされているので、 変数選択をした方が誤差が少ないことが分かりました。 ただ、あまり二乗誤差の違いは大きくないです。</p> <h3 id="例40"><a href="#例40" class=header-anchor >例40</a></h3> <p>kの値を変えたときのCVの予測誤差の変化</p> <pre><code class=language-julia >n &#61; 100; p &#61; 5;
p40 &#61; plot&#40;ylims&#61;&#40;0.3,1.5&#41;,xlabel&#61;&quot;k&quot;,ylabel&#61;&quot;CVの値&quot;,
            title&#61;&quot;k-foldのkとCVの値の関係&quot;,legend&#61;false&#41;
Random.seed&#33;&#40;1&#41;
for _ in 1:10
    X &#61; randn&#40;n,p&#41;
    β &#61; randn&#40;p&#43;1&#41;
    y &#61; insert_ones&#40;X&#41; * β &#43; randn&#40;n&#41;
    U &#61; Int&#91;&#93;
    V &#61; Float64&#91;&#93;
    for k in 2:n
        if n&#37;k&#61;&#61;0
            push&#33;&#40;U,k&#41;
            push&#33;&#40;V, cv_linear&#40;X,y,k&#41;&#41;
        end
    end
    plot&#33;&#40;p40,U,V&#41;
end</code></pre> <img src="/Joe.jl/assets/StatisticalML/chap3/code/output/fig3-2.svg" alt=""> <h3 id="例41_finsherのあやめ"><a href="#例41_finsherのあやめ" class=header-anchor >例41 &#40;FInsherのあやめ&#41;</a></h3> <p>あやめのデータセットでK近傍法のｋ毎に誤り率を評価します。</p> <pre><code class=language-julia >using RDatasets, StatsBase, Random, Plots
using Joe:knn
iris &#61; dataset&#40;&quot;datasets&quot;,&quot;iris&quot;&#41;
X &#61; iris&#91;&#33;,1:4&#93; |&gt; Matrix
targets&#61;unique&#40;iris.Species&#41;;</code></pre><pre><code class="plaintext code-output">Failed to precompile RDatasets [ce6b1742-4840-55fa-b093-852dadbb1d8b] to /home/runner/.julia/compiled/v1.6/RDatasets/jl_RWqbbl.
</code></pre> <p>あやめの種類をIntに変換します。</p> <pre><code class=language-julia >label &#61; Dict&#40;target&#61;&gt;i for &#40;i,target&#41; in enumerate&#40;targets&#41;&#41;
y &#61; &#91;label&#91;i&#93; for i in iris.Species&#93;;
n &#61; length&#40;y&#41;;</code></pre><pre><code class="plaintext code-output">UndefVarError: targets not defined
</code></pre> <p>データセットをランダムに並べ替えておきます。</p> <pre><code class=language-julia >Random.seed&#33;&#40;1&#41;
order &#61; sample&#40;1:n,n,replace&#61;false&#41;
X &#61; X&#91;order,:&#93;; y &#61; y&#91;order&#93;;</code></pre><pre><code class="plaintext code-output">UndefVarError: sample not defined
</code></pre> <p>10-foldクロスバリデーションなので、テストデータを15毎に交代させることになります。</p> <pre><code class=language-julia >errorRate &#61; Vector&#123;Float64&#125;&#40;undef,10&#41;
for k in 1:10
    S &#61; 0
    for top in 1:15:150
        test &#61; top:top&#43;14
        train &#61; setdiff&#40;1:150,test&#41;
        knn_ans &#61; knn&#40;X&#91;train,:&#93;,y&#91;train&#93;,X&#91;test,:&#93;,k&#41;
        S &#43;&#61; sum&#40;y&#91;test&#93; .&#33;&#61; knn_ans&#41;
    end
    S /&#61; n
    errorRate&#91;k&#93; &#61; S
end
p41 &#61; plot&#40;errorRate,xlabel&#61;&quot;K&quot;,ylabel&#61;&quot;誤り率&quot;,
            legend&#61;false, title&#61;&quot;CVによる誤り率の評価&quot;&#41;</code></pre><pre><code class="plaintext code-output">BoundsError: attempt to access 100×5 Matrix{Float64} at index [[16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150], 1:5]
</code></pre> <p><p><span style="color:red;">// Image matching '/assets/StatisticalML/chap3/code/fig3-3' not found. //</span></p> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>≥</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">K \ge 3</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8193em;vertical-align:-0.13597em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≥</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >3</span></span></span></span>で大きく誤り率が低下することが分かりました。 pythonでは実行に10分程度かかったとありますが、いくらなんでも遅すぎでは？&#40;juliaは瞬殺&#41;</p> <h2 id="線形回帰の場合の公式cvの公式"><a href="#線形回帰の場合の公式cvの公式" class=header-anchor >線形回帰の場合の公式&#40;CVの公式&#41;</a></h2> <p>クロスバリデーションでの誤差の分析は、訓練データ毎に重回帰分析を行う必要があるので、 処理に時間がかかります。<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent=true ><mi>β</mi><mo>^</mo></mover><mrow><mo>−</mo><mi>S</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\hat{\beta}_{-S}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.1662109999999999em;vertical-align:-0.208331em;"></span><span class=mord ><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.9578799999999998em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.16666em;"><span class=mord >^</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.19444em;"><span></span></span></span></span></span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>をあらわに求めることなく、CVを 楽して評価できるのがこの公式です。&#40;<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>はテストデータの集合、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">-S</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.76666em;vertical-align:-0.08333em;"></span><span class=mord >−</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>は訓練データの集合&#41; <div class=blank ></div></p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><munder><mo>∑</mo><mi>S</mi></munder><mi mathvariant=normal >∣</mi><mi mathvariant=normal >∣</mi><mo stretchy=false >(</mo><mi>I</mi><mo>−</mo><msub><mi>H</mi><mi>S</mi></msub><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msub><mi>e</mi><mi>S</mi></msub><mi mathvariant=normal >∣</mi><msup><mi mathvariant=normal >∣</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sum_{S} || (I - H_S)^{-1}e_S||^2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:2.344341em;vertical-align:-1.294336em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.0500050000000003em;"><span style="top:-1.855664em;margin-left:0em;"><span class=pstrut  style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span style="top:-3.050005em;"><span class=pstrut  style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:1.294336em;"><span></span></span></span></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >∣</span><span class=mord >∣</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mord >∣</span><span class=mord ><span class=mord >∣</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> <p>ただし、<span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>S</mi></msub><mo>=</mo><msub><mi>X</mi><mi>S</mi></msub><mo stretchy=false >(</mo><msup><mi>X</mi><mi mathvariant=sans-serif >T</mi></msup><mi>X</mi><msup><mo stretchy=false >)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><msubsup><mi>X</mi><mi>S</mi><mi mathvariant=sans-serif >T</mi></msubsup></mrow><annotation encoding="application/x-tex">H_S = X_S(X^\mathsf{T}X)^{-1}X_S^\mathsf{T}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.83333em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.124439em;vertical-align:-0.275331em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=mclose ><span class=mclose >)</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.849108em;"><span style="top:-2.424669em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathsf mtight">T</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.275331em;"><span></span></span></span></span></span></span></span></span></span>、 <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>S</mi></msub><mo>=</mo><msub><mi>y</mi><mi>S</mi></msub><mo>−</mo><msub><mi>X</mi><mi>S</mi></msub><mover accent=true ><mi>β</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">e_S = y_S - X_S\hat{\beta}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">e</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1523199999999998em;vertical-align:-0.19444em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.9578799999999998em;"><span style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span><span style="top:-3.26344em;"><span class=pstrut  style="height:3em;"></span><span class=accent-body  style="left:-0.16666em;"><span class=mord >^</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.19444em;"><span></span></span></span></span></span></span></span></span> です。プログラムを実装して、ベンチマークをしてみます。 cv_fast関数は次のように実装しました。</p> <pre><code class=language-julia >function cv_fast&#40;X::AbstractArray,y::Vector,K::Int&#41;
    n &#61; length&#40;y&#41;; m &#61; round&#40;Int,n/K&#41;
    X &#61; insert_ones&#40;X&#41;
    H &#61; X*&#40;&#40;X&#39;X&#41;\X&#39;&#41;
    e &#61; &#40;I&#40;n&#41; - H&#41;*y
    S &#61; 0
    @views for j in 1:K
        test &#61; j*m-m&#43;1:j*m;
        err &#61; &#40;I&#40;m&#41;-H&#91;test,test&#93;&#41; \ e&#91;test&#93;
        S &#43;&#61; dot&#40;err,err&#41;
    end
    return S/n
end</code></pre> <pre><code class=language-julia >using Joe, Random, Plots
using Joe:cv_linear,cv_fast

n &#61; 1000; p &#61; 5
Random.seed&#33;&#40;1&#41;
X &#61; randn&#40;n, p&#41;
β &#61; randn&#40;p&#43;1&#41;; β&#91;2:3&#93; .&#61; 0
y &#61; insert_ones&#40;X&#41;*β &#43; randn&#40;n&#41;;</code></pre> <p>ループのネストを浅くしたいので、K-foldのkのリストを作って、ループすることにします。</p> <pre><code class=language-julia >K &#61; &#91;i for i in 2:1000 if 1000&#37;i &#61;&#61;0&#93;
t_linear &#61; Vector&#123;Float64&#125;&#40;undef,length&#40;K&#41;&#41;;
t_fast &#61; similar&#40;t_linear&#41;;</code></pre> <p>まずは関数の慣らし運転を</p> <pre><code class=language-julia >@show cv_linear&#40;X,y,10&#41;
@show cv_fast&#40;X,y,10&#41;</code></pre><pre><code class="plaintext code-output">cv_linear(X, y, 10) = 0.998850226625682
cv_fast(X, y, 10) = 0.9988502266256818
</code></pre> <p>値が一致することは確認できました。それでは、いざ本番&#33;</p> <pre><code class=language-julia >for i in eachindex&#40;K&#41;
    start &#61; time_ns&#40;&#41;;cv_fast&#40;X,y,K&#91;i&#93;&#41;;stop &#61; time_ns&#40;&#41;
    t_fast&#91;i&#93; &#61; &#40;stop-start&#41;/1e9
    start &#61; time_ns&#40;&#41;;cv_linear&#40;X,y,K&#91;i&#93;&#41;;stop &#61; time_ns&#40;&#41;
    t_linear&#91;i&#93; &#61; &#40;stop-start&#41;/1e9
end
p42 &#61; plot&#40;ylims&#61;&#40;0.0,0.5&#41;, xlabel &#61; &quot;k&quot; ,ylabel&#61;&quot;実行時間&quot;,
           label&#61;&quot;cv_linear&quot;,title&#61;&quot;cv_fastとcv_linearの比較&quot;,
           legend&#61;:topleft&#41;
plot&#33;&#40;p42,K, t_linear, label&#61;&quot;cv_linear&quot;&#41;
plot&#33;&#40;p42,K, t_fast, label&#61;&quot;cv_fast&quot;&#41;</code></pre> <p><img src="/Joe.jl/assets/StatisticalML/chap3/code/output/fig3-4.svg" alt=""> <div class=blank ></div> <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>≥</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">n\ge100</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathnormal">n</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≥</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span><span class=mord >0</span><span class=mord >0</span></span></span></span>ではcv_fastの方が実行時間が短いことが分かります。 原著と比べると、マシンの違いがあるとはいえ、juliaは速いということもよくわかります。</p> <h2 id="ブートストラップ"><a href="#ブートストラップ" class=header-anchor >ブートストラップ</a></h2> <p>以下のような複合型とbootstrap関数を定義しました。 原著のコードよりは可読性が向上したかなぁ。</p> <pre><code class=language-julia >using Parameters
@with_kw mutable struct bt&#123;T&lt;:Number&#125;
    original::T &#61; 0.0
    bias::T &#61; 0.0
    stderr::T &#61; 0.0
end
function bootstrap&#40;df::AbstractArray&#123;T&#125;, F::Function, r::Int&#41; where T &lt;:Number
    m,_ &#61; size&#40;df&#41;
    original &#61; F&#40;df,1:m&#41;
    u &#61; Vector&#123;T&#125;&#40;undef, r&#41;
    for i in 1:r
        index &#61; sample&#40;1:m,m,replace&#61;true&#41;
        u&#91;i&#93; &#61; F&#40;df,index&#41;
    end
    bias &#61; mean&#40;u&#41; - original; stderr &#61; std&#40;u&#41;
    result &#61; bt&#40;&#41;
    @pack&#33; result &#61; original, bias, stderr
end</code></pre> <h3 id="例43"><a href="#例43" class=header-anchor >例43</a></h3> <p>データは<a href="https://bitbucket.org/prof-joe/statistical_learning_with_python/src/master/">ここ</a>からダウンロードできます。</p> <pre><code class=language-julia >using DelimitedFiles, Statistics
using Joe:bootstrap
function func_1&#40;data,index&#41;
    X&#61;data&#91;index,1&#93;; Y&#61; data&#91;index,2&#93;
    &#40;var&#40;Y&#41; - var&#40;X&#41;&#41;/&#40;var&#40;X&#41; &#43; var&#40;Y&#41; -2cov&#40;X,Y&#41;&#41;
end
Portfolio &#61; readdlm&#40;joinpath&#40;&quot;_assets&quot;,&quot;data&quot;,&quot;Portfolio.csv&quot;&#41;,&#39;,&#39;, skipstart&#61;1&#41;
bootstrap&#40;Portfolio,func_1,1000&#41;</code></pre><pre><code class="plaintext code-output">Joe.bt{Float64}
  original: Float64 0.15166414929676297
  bias: Float64 0.004649732171157606
  stderr: Float64 0.1778099728130236
</code></pre> <h3 id="例44"><a href="#例44" class=header-anchor >例44</a></h3> <p>データの読み込み</p> <pre><code class=language-julia >using Joe,DelimitedFiles
df &#61; readdlm&#40;joinpath&#40;&quot;_assets&quot;,&quot;data&quot;,&quot;crime.txt&quot;&#41;&#41;
X &#61; df&#91;:,3:4&#93;; y &#61;df&#91;:,1&#93;
β &#61; multiple_regression&#40;X,y&#41;</code></pre><pre><code class="plaintext code-output">3-element Vector{Float64}:
 621.4260363802932
  11.858330796711074
  -5.973411688165022</code></pre> <p>回帰係数のそれぞれについて、ブートストラップ法を適用します。ここでは標準偏差だけを出力します。</p> <pre><code class=language-julia >std_bt &#61; ones&#40;3&#41;
for j in 1:3
    function func_2&#40;data,index&#41;
        X &#61; data&#91;index,3:4&#93;;y &#61; data&#91;index,1&#93;
        β &#61; multiple_regression&#40;X,y&#41;
        return β&#91;j&#93;
    end
    std_bt&#91;j&#93; &#61; bootstrap&#40;df,func_2,1000&#41;.stderr
end
std_bt</code></pre><pre><code class="plaintext code-output">3-element Vector{Float64}:
 225.1378640692539
   3.5897174857559833
   3.3787774264714807</code></pre> <p>GLM.jlで回帰係数を推定したときの標準偏差と比較してみます。</p> <pre><code class=language-julia >using GLM, DataFrames
data &#61; DataFrame&#40;df,:auto&#41;
ols &#61; lm&#40;@formula&#40;x1 ~ x3 &#43; x4&#41;, data&#41;</code></pre><pre><code class="plaintext code-output">StatsModels.TableRegressionModel{GLM.LinearModel{GLM.LmResp{Vector{Float64}}, GLM.DensePredChol{Float64, LinearAlgebra.CholeskyPivoted{Float64, Matrix{Float64}}}}, Matrix{Float64}}

x1 ~ 1 + x3 + x4

Coefficients:
──────────────────────────────────────────────────────────────────────────
                 Coef.  Std. Error      t  Pr(>|t|)  Lower 95%   Upper 95%
──────────────────────────────────────────────────────────────────────────
(Intercept)  621.426     222.685     2.79    0.0076  173.441    1069.41
x3            11.8583      2.568     4.62    <1e-04    6.69219    17.0245
x4            -5.97341     3.56144  -1.68    0.1001  -13.1381      1.19129
──────────────────────────────────────────────────────────────────────────</code></pre> <p>標準偏差がほぼ一致することが分かりました。</p> <p style="text-align:right"> めでたしめでたし </p> <button onclick="topFunction()" id=myBtn  title="Go to top">Top</button> </p> <div class=page-foot > <div class=copyright > &copy; Kei Hanafusa. Last modified: August 09, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </main> <script src="/Joe.jl/libs/vela/metisMenu.min.js"></script> <script src="/Joe.jl/libs/vela/slideout.min.js"></script> <script src="/Joe.jl/libs/myBtn/myBtn.js"></script> <script src="/Joe.jl/libs/popup/jquery.magnific-popup.min.js"></script> <script src="/Joe.jl/libs/popup/mypopup.js"></script> <script src="/Joe.jl/libs/highlight/highlight.pack.js"></script> <script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: ' '});</script>